<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <title>제품 분류 관리 - 마이넷 매출 관리 시스템</title>
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <script th:src="@{/js/common.js}" defer></script>
  </head>
  <body>
    <!-- 헤더 -->
    <header class="header">
      <div class="header-content">
        <div class="logo">마이넷 매출 관리 시스템</div>
        <div class="user-info">
          <a th:href="@{/change-password}" class="change-password-link">비밀번호 변경</a>
          <span
            class="user-name"
            th:text="${#authentication.principal.username}"
            >마이넷</span
          >
          <span class="user-company" th:text="'(' + ${#authentication.principal.companyName} + ')'">(마이넷)</span>
          <form th:action="@{/logout}" method="post" style="display: inline">
            <button type="submit" class="logout-btn">로그아웃</button>
          </form>
        </div>
      </div>
    </header>

    <!-- 네비게이션 -->
    <nav class="nav-menu">
      <div class="nav-content">
        <div class="nav-item"  th:if="${!#authentication.principal.canon}">
          <a th:href="@{/mynet/daily-sales}">일일매출현황</a>
        </div>
        <div class="nav-item">
          <a
            th:href="@{${#authentication.principal.canon ? '/canon/view' : '/mynet/view'}}"
            >조회</a
          >
        </div>
        <div
          class="nav-item"
          th:classappend="${currentPage == 'compare'} ? 'active'"
        >
          <a href="javascript:void(0)">비교 ▼</a>
          <div class="sub-menu">
            <a
              th:href="@{${#authentication.principal.canon ? '/canon/compare/monthly' : '/mynet/compare/monthly'}}"
              th:classappend="${comparePage == 'monthly'} ? 'active'"
              >월별</a
            >
            <a
              th:href="@{${#authentication.principal.canon ? '/canon/compare/yearly' : '/mynet/compare/yearly'}}"
              th:classappend="${comparePage == 'yearly'} ? 'active'"
              >년도별</a
            >
            <a
              th:href="@{${#authentication.principal.canon ? '/canon/compare/period' : '/mynet/compare/period'}}"
              th:classappend="${comparePage == 'period'} ? 'active'"
              >기간별</a
            >
            <a
              th:href="@{${#authentication.principal.canon ? '/canon/compare/product' : '/mynet/compare/product'}}"
              th:classappend="${comparePage == 'product'} ? 'active'"
              >제품별</a
            >
          </div>
        </div>

        <div
          class="nav-item active"
          th:classappend="${currentPage == 'products'} ? 'active'"
        >
          <a th:href="@{/admin/products}">제품 분류</a>
        </div>

        <div
          class="nav-item"
          th:classappend="${currentPage == 'users'} ? 'active'"
          th:if="${!isCanon}"
        >
          <a th:href="@{/admin/users}">사용자 관리</a>
        </div>
      </div>
    </nav>

    <!-- 메인 컨텐츠 -->
    <main class="main-container">
      <div id="alert-container"></div>

      <!-- 제품 등록 버튼 -->
      <div class="action-header">
        <button sec:authorize="!hasRole('CANON')" 
          class="btn btn-success"
          id="addCategoryBtn" 
          onclick="toggleCategoryForm()">
          분류 관리
        </button>
        <button
          sec:authorize="!hasRole('CANON')"
          class="btn btn-primary"
          id="addProductBtn"
          onclick="toggleProductForm()"
        >
          제품 등록
        </button>
      </div>

      <!-- 분류 관리 패널 -->
      <div class="card" id="categoryForm" style="display: none">
        <div class="card-header">
          <h3 class="card-title">분류 관리</h3>
        </div>

        <!-- 새 분류 추가 -->
        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
          <input type="text" class="form-input" id="newCategoryInput"
            placeholder="새 분류명 입력 (제품에 배정될 때 저장됩니다)" style="max-width: 320px;" />
          <button class="btn btn-success" onclick="submitNewCategory()">추가</button>
        </div>

        <!-- 현재 분류 목록 -->
        <table style="width:100%; border-collapse:collapse; font-size:14px;">
          <thead>
            <tr>
              <th style="background:#2c5aa0; color:white; padding: 10px; width:25%;">분류명</th>
              <th style="background:#2c5aa0; color:white; width:15%; width:80px;">제품 수</th>
              <th style="background:#2c5aa0; color:white; width:40%; width:200px;">이름 변경</th>
              <th style="background:#2c5aa0; color:white; width:20%; width:80px;">삭제</th>
            </tr>
          </thead>
          <tbody id="categoryManageList">
            <!-- JS로 채워짐 -->
          </tbody>
        </table>

        <div style="margin-top: 15px; text-align: right;">
          <button class="btn btn-outline" onclick="toggleCategoryForm()">닫기</button>
        </div>
      </div>

      <!-- 제품 등록 폼 (숨김 상태) -->
      <div class="card" id="productForm" style="display: none">
        <div class="card-header">
          <h3 class="card-title">새 제품 등록</h3>
        </div>
        <form id="productRegistrationForm">
          <div class="form-table-container">
            <table class="form-table">
              <thead>
                <tr>
                  <th class="form-header">분류</th>
                  <th class="form-header">제품코드</th>
                  <th class="form-header">제품명</th>
                  <th class="form-header" th:if="${!#authentication.principal.canon}">원가</th>
                  <th class="form-header" th:if="${!#authentication.principal.canon}">판매가</th>
                  <th class="form-header">액션</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="form-cell">
                    <select class="form-input" id="categoryInput" required>
                      <option value="">분류 선택</option>
                      <option
                        th:each="category : ${existingCategories}"
                        th:value="${category}"
                        th:text="${category}"
                      ></option>
                    </select>
                  </td>
                  <td class="form-cell">
                    <input
                      type="text"
                      class="form-input"
                      id="productCodeInput"
                      th:value="${nextProductCode}"
                      readonly
                    />
                  </td>
                  <td class="form-cell">
                    <input
                      type="text"
                      class="form-input"
                      id="productNameInput"
                      placeholder="제품명 입력"
                      required
                    />
                  </td>
                  <td class="form-cell">
                    <input
                      type="number"
                      class="form-input"
                      id="costPriceInput"
                      placeholder="원가"
                      step="0.01"
                      min="0"
                      required
                    />
                  </td>
                  <td class="form-cell">
                    <input
                      type="number"
                      class="form-input"
                      id="supplyPriceInput"
                      placeholder="판매가"
                      step="0.01"
                      min="0"
                      required
                    />
                  </td>
                  <td class="form-cell">
                    <button type="submit" class="btn btn-success">등록</button>
                    <button
                      type="button"
                      class="btn btn-outline"
                      onclick="cancelProductForm()"
                    >
                      취소
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </form>
      </div>

      <!-- 제품 목록 테이블 -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">제품 목록</h3>
        </div>
        <div class="product-table-container">
          <table class="product-table" id="productListTable">
            <thead>
              <tr>
                <th class="product-header">분류</th>
                <th class="product-header">제품코드</th>
                <th class="product-header">제품명</th>
                <th class="product-header" th:if="${!#authentication.principal.canon}">원가</th>
                <th class="product-header" th:if="${!#authentication.principal.canon}">판매가</th>
                <th class="product-header">상태</th>
                <th class="product-header">등록일</th>
                <th class="product-header">액션</th>
              </tr>
            </thead>
            <tbody id="productTableBody">
              <!-- 카테고리별로 그룹화된 제품 목록 -->
              <th:block
                th:each="categoryGroup, categoryGroupStat : ${productsByCategory}"
              >
                <!-- 각 카테고리의 제품들 -->
                <th:block
                  th:each="product, productStat : ${categoryGroup.value}"
                >
                  <tr th:if="${productStat.first}">
                    <!-- 첫 번째 제품의 경우 카테고리 셀 포함 -->
                    <td
                      class="category-cell"
                      th:rowspan="${categoryGroup.value.size()}"
                      th:data-category="${categoryGroup.key}">
                      <span class="category-display" th:text="${categoryGroup.key}"></span>
                      <select class="category-select" style="display:none;">
                        <option th:each="cat : ${existingCategories}"
                                th:value="${cat}" th:text="${cat}"
                                th:selected="${cat == categoryGroup.key}"></option>
                      </select>
                    </td>
                    <td
                      class="data-cell"
                      th:text="${product.productCode}"
                      th:class="'data-cell ' + ${product.categoryClass} + (${!product.active} ? ' inactive' : '')"
                    ></td>
                    <td
                      class="data-cell"
                      th:text="${product.productName}"
                      th:class="'data-cell ' + ${product.categoryClass} + (${!product.active} ? ' inactive' : '')"
                    ></td>
                    <!-- 원가 셀 -->
                    <td th:if="${!#authentication.principal.canon}" class="data-cell editable-price-cell tooltip"
                        th:classappend="' ' + ${product.categoryClass} + (${!product.active} ? ' inactive' : '')"
                        th:data-product-id="${product.id}"
                        th:data-price-type="cost"
                        th:data-original-value="${product.currentCostPrice}"
                        th:data-tooltip="${product.lastModifiedAt != null ? 
                              '최근 수정: ' + #temporals.format(product.lastModifiedAt, 'yyyy-MM-dd HH:mm') + 
                              (product.lastModifiedBy != null ? ' by ' + product.lastModifiedBy : '') 
                              : '수정 기록 없음'}">
                        <span class="price-display" th:text="${#numbers.formatDecimal(product.currentCostPrice, 0, 'COMMA', 0, 'POINT')}"></span>
                        <input type="number" class="price-input" style="display:none;" 
                              th:value="${product.currentCostPrice.intValue()}" step="1" min="0">
                    </td>

                    <!-- 판매가 셀 -->
                    <td th:if="${!#authentication.principal.canon}" class="data-cell editable-price-cell tooltip"
                        th:classappend="' ' + ${product.categoryClass} + (${!product.active} ? ' inactive' : '')"
                        th:data-product-id="${product.id}"
                        th:data-price-type="supply"
                        th:data-original-value="${product.currentSupplyPrice}"
                        th:data-tooltip="${product.lastModifiedAt != null ? 
                              '최근 수정: ' + #temporals.format(product.lastModifiedAt, 'yyyy-MM-dd HH:mm') + 
                              (product.lastModifiedBy != null ? ' by ' + product.lastModifiedBy : '') 
                              : '수정 기록 없음'}">
                        <span class="price-display" th:text="${#numbers.formatDecimal(product.currentSupplyPrice, 0, 'COMMA', 0, 'POINT')}"></span>
                        <input type="number" class="price-input" style="display:none;" 
                              th:value="${product.currentSupplyPrice.intValue()}" step="1" min="0">
                    </td>
                    <td
                      class="data-cell"
                      th:class="'data-cell ' + ${product.categoryClass} + (${!product.active} ? ' inactive' : '')"
                    >
                      <span
                        class="status-badge"
                        th:class="${product.active ? 'status-active' : 'status-inactive'}"
                        th:text="${product.active ? '활성' : '비활성'}"
                      ></span>
                    </td>
                    <td
                      class="data-cell"
                      th:text="${#temporals.format(product.createdAt, 'yyyy-MM-dd')}"
                      th:class="'data-cell ' + ${product.categoryClass} + (${!product.active} ? ' inactive' : '')"
                    ></td>
                    <td class="data-cell"
                        th:class="'data-cell ' + ${product.categoryClass} + (${!product.active} ? ' inactive' : '')">
                        <button class="btn btn-sm btn-primary edit-price-btn"
                                th:if="${!#authentication.principal.canon}"
                                th:data-product-id="${product.id}"
                                onclick="editProductPrice(this)">
                            수정
                        </button>
                        <button class="btn btn-sm btn-success save-price-btn"
                                style="display:none;"
                                th:data-product-id="${product.id}"
                                onclick="saveProductPrice(this)">
                            저장
                        </button>
                        <button class="btn btn-sm btn-secondary cancel-price-btn"
                                style="display:none;"
                                th:data-product-id="${product.id}"
                                onclick="cancelEditPrice(this)">
                            취소
                        </button>
                        <button class="btn btn-sm btn-outline"
                                th:classappend="${#authentication.principal.canon} ? ' disabled-button' : ''"
                                th:attr="disabled=${#authentication.principal.canon}"
                                th:onclick="'toggleProductStatus(' + ${product.id} + ', ' + ${product.active} + ')'"
                                th:text="${product.active ? '비활성화' : '활성화'}">
                        </button>
                    </td>
                  </tr>
                  <tr th:unless="${productStat.first}">
                    <!-- 나머지 제품들 -->
                    <td
                      class="data-cell"
                      th:text="${product.productCode}"
                      th:class="'data-cell ' + ${product.categoryClass} + (${!product.active} ? ' inactive' : '')"
                    ></td>
                    <td
                      class="data-cell"
                      th:text="${product.productName}"
                      th:class="'data-cell ' + ${product.categoryClass} + (${!product.active} ? ' inactive' : '')"
                    ></td>
                    <!-- 원가 셀 -->
                    <td th:if="${!#authentication.principal.canon}" class="data-cell editable-price-cell tooltip"
                        th:classappend="' ' + ${product.categoryClass} + (${!product.active} ? ' inactive' : '')"
                        th:data-product-id="${product.id}"
                        th:data-price-type="cost"
                        th:data-original-value="${product.currentCostPrice}"
                        th:data-tooltip="${product.lastModifiedAt != null ? 
                              '최근 수정: ' + #temporals.format(product.lastModifiedAt, 'yyyy-MM-dd HH:mm') + 
                              (product.lastModifiedBy != null ? ' by ' + product.lastModifiedBy : '') 
                              : '수정 기록 없음'}">
                        <span class="price-display" th:text="${#numbers.formatDecimal(product.currentCostPrice, 0, 'COMMA', 0, 'POINT')}"></span>
                        <input type="number" class="price-input" style="display:none;" 
                              th:value="${product.currentCostPrice.intValue()}" step="1" min="0">
                    </td>

                    <!-- 판매가 셀 -->
                    <td th:if="${!#authentication.principal.canon}" class="data-cell editable-price-cell tooltip"
                        th:classappend="' ' + ${product.categoryClass} + (${!product.active} ? ' inactive' : '')"
                        th:data-product-id="${product.id}"
                        th:data-price-type="supply"
                        th:data-original-value="${product.currentSupplyPrice}"
                        th:data-tooltip="${product.lastModifiedAt != null ? 
                              '최근 수정: ' + #temporals.format(product.lastModifiedAt, 'yyyy-MM-dd HH:mm') + 
                              (product.lastModifiedBy != null ? ' by ' + product.lastModifiedBy : '') 
                              : '수정 기록 없음'}">
                        <span class="price-display" th:text="${#numbers.formatDecimal(product.currentSupplyPrice, 0, 'COMMA', 0, 'POINT')}"></span>
                        <input type="number" class="price-input" style="display:none;" 
                              th:value="${product.currentSupplyPrice.intValue()}" step="1" min="0">
                    </td>
                    <td
                      class="data-cell"
                      th:class="'data-cell ' + ${product.categoryClass} + (${!product.active} ? ' inactive' : '')"
                    >
                      <span
                        class="status-badge"
                        th:class="${product.active ? 'status-active' : 'status-inactive'}"
                        th:text="${product.active ? '활성' : '비활성'}"
                      ></span>
                    </td>
                    <td
                      class="data-cell"
                      th:text="${#temporals.format(product.createdAt, 'yyyy-MM-dd')}"
                      th:class="'data-cell ' + ${product.categoryClass} + (${!product.active} ? ' inactive' : '')"
                    ></td>
                    <td class="data-cell"
                      th:class="'data-cell ' + ${product.categoryClass} + (${!product.active} ? ' inactive' : '')">
                      <button class="btn btn-sm btn-primary edit-price-btn"
                              th:if="${!#authentication.principal.canon}"
                              th:data-product-id="${product.id}"
                              onclick="editProductPrice(this)">
                          수정
                      </button>
                      <button class="btn btn-sm btn-success save-price-btn"
                              style="display:none;"
                              th:data-product-id="${product.id}"
                              onclick="saveProductPrice(this)">
                          저장
                      </button>
                      <button class="btn btn-sm btn-secondary cancel-price-btn"
                              style="display:none;"
                              th:data-product-id="${product.id}"
                              onclick="cancelEditPrice(this)">
                          취소
                      </button>
                      <button class="btn btn-sm btn-outline"
                              th:classappend="${#authentication.principal.canon} ? ' disabled-button' : ''"
                              th:attr="disabled=${#authentication.principal.canon}"
                              th:onclick="'toggleProductStatus(' + ${product.id} + ', ' + ${product.active} + ')'"
                              th:text="${product.active ? '비활성화' : '활성화'}">
                      </button>
                  </td>
                  </tr>
                </th:block>
              </th:block>
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <script>

      window.addEventListener("load", () => {
        const roleEl = document.querySelector(".user-role");
        if (roleEl && roleEl.textContent.includes("캐논")) {
          document.querySelectorAll("button").forEach(btn => {
            btn.disabled = true;
            btn.classList.add("disabled-button");
          });
        }
      });

      // 제품 등록 폼 토글
      function toggleProductForm() {
        const form = document.getElementById("productForm");
        const btn = document.getElementById("addProductBtn");

        if (form.style.display === "none" || form.style.display === "") {
          form.style.display = "block";
          btn.textContent = "등록 취소";
          btn.classList.remove("btn-primary");
          btn.classList.add("btn-outline");
        } else {
          cancelProductForm();
        }
      }

      // 제품 등록 폼 취소
      function cancelProductForm() {
        const form = document.getElementById("productForm");
        const btn = document.getElementById("addProductBtn");
        const formElement = document.getElementById("productRegistrationForm");

        form.style.display = "none";
        btn.textContent = "제품 등록";
        btn.classList.remove("btn-outline");
        btn.classList.add("btn-primary");
        formElement.reset();
      }

      // 제품 등록 폼 제출
      document
        .getElementById("productRegistrationForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const formData = {
            category: document.getElementById("categoryInput").value,
            productCode: document.getElementById("productCodeInput").value,
            productName: document.getElementById("productNameInput").value,
            costPrice: parseFloat(
              document.getElementById("costPriceInput").value
            ),
            supplyPrice: parseFloat(
              document.getElementById("supplyPriceInput").value
            ),
          };

          // AJAX로 제품 등록
          const xhr = new XMLHttpRequest();
          xhr.open("POST", "/admin/products/register", true);
          xhr.setRequestHeader("Content-Type", "application/json");

          const csrfToken = document.querySelector('meta[name="_csrf"]');
          if (csrfToken) {
            xhr.setRequestHeader(
              document
                .querySelector('meta[name="_csrf_header"]')
                .getAttribute("content"),
              csrfToken.getAttribute("content")
            );
          }

          xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
              if (xhr.status === 200) {
                showAlert("제품이 등록되었습니다.", "success");
                setTimeout(() => {
                  location.reload();
                }, 1000);
              } else {
                showAlert("제품 등록 중 오류가 발생했습니다.", "error");
              }
            }
          };

          xhr.send(JSON.stringify(formData));
        });

      // 제품 상태 토글 (활성/비활성)
      function toggleProductStatus(productId, currentStatus) {
        const action = currentStatus ? "deactivate" : "activate";
        const message = currentStatus ? "비활성화" : "활성화";

        if (confirm(`정말로 이 제품을 ${message}하시겠습니까?`)) {
          const xhr = new XMLHttpRequest();
          xhr.open("POST", `/admin/products/${productId}/${action}`, true);

          const csrfToken = document.querySelector('meta[name="_csrf"]');
          if (csrfToken) {
            xhr.setRequestHeader(
              document
                .querySelector('meta[name="_csrf_header"]')
                .getAttribute("content"),
              csrfToken.getAttribute("content")
            );
          }

          xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
              if (xhr.status === 200) {
                showAlert(`제품이 ${message}되었습니다.`, "success");
                setTimeout(() => {
                  location.reload();
                }, 1000);
              } else {
                showAlert(`제품 ${message} 중 오류가 발생했습니다.`, "error");
              }
            }
          };

          xhr.send();
        }
      }

      // 알림 표시
      function showAlert(message, type = "info") {
        const container = document.getElementById("alert-container");
        const alert = document.createElement("div");
        alert.className = `alert alert-${type}`;
        alert.textContent = message;

        const closeBtn = document.createElement("button");
        closeBtn.innerHTML = "×";
        closeBtn.onclick = () => alert.remove();
        alert.appendChild(closeBtn);

        container.appendChild(alert);
        setTimeout(() => alert.remove(), 3000);
      }

    /**
     * 버튼 상태 초기화
     */
    function resetPriceButtons(row, productId) {
        const editBtn = row.querySelector(`.edit-price-btn[data-product-id="${productId}"]`);
        const saveBtn = row.querySelector(`.save-price-btn[data-product-id="${productId}"]`);
        const cancelBtn = row.querySelector(`.cancel-price-btn[data-product-id="${productId}"]`);
        
        editBtn.style.display = 'inline-block';
        saveBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
    }

    function editProductPrice(button) {
        // 동시 편집 방지
        if (document.querySelector('.injected-category-cell') || 
            document.querySelector('.category-cell[data-original-span]')) {
            showAlert('이미 다른 행을 수정 중입니다. 저장하거나 취소 후 진행하세요.', 'info');
            return;
        }
        const productId = button.dataset.productId;
        const row = button.closest('tr');

        // 원가/판매가 편집 활성화
        const priceCells = row.querySelectorAll(`.editable-price-cell[data-product-id="${productId}"]`);
        priceCells.forEach(cell => {
            cell.querySelector('.price-display').style.display = 'none';
            cell.querySelector('.price-input').style.display = 'inline-block';
        });

        // rowspan 해제 → 이 행에 독립적인 분류 셀 생성
        expandCategoryRowspan(row);

        const editBtn = row.querySelector(`.edit-price-btn[data-product-id="${productId}"]`);
        const saveBtn = row.querySelector(`.save-price-btn[data-product-id="${productId}"]`);
        const cancelBtn = row.querySelector(`.cancel-price-btn[data-product-id="${productId}"]`);

        editBtn.style.display = 'none';
        saveBtn.style.display = 'inline-block';
        cancelBtn.style.display = 'inline-block';
    }

    function expandCategoryRowspan(targetRow) {
        // 이 행 또는 이전 행에서 category-cell 찾기
        let categoryCell = targetRow.querySelector('.category-cell');
        let groupFirstRow = targetRow;

        if (!categoryCell) {
            let prev = targetRow.previousElementSibling;
            while (prev) {
                const cell = prev.querySelector('.category-cell');
                if (cell) { categoryCell = cell; groupFirstRow = prev; break; }
                prev = prev.previousElementSibling;
            }
        }
        if (!categoryCell) return;

        const originalSpan = parseInt(categoryCell.rowSpan) || 1;
        const categoryName = categoryCell.querySelector('.category-display')?.textContent.trim() || categoryCell.dataset.category;

        // 원복용 데이터 저장
        categoryCell.dataset.originalSpan = originalSpan;
        categoryCell.dataset.originalCategory = categoryName;

        // 원본 셀 → rowspan 1로 축소 + select로 교체
        categoryCell.rowSpan = 1;
        categoryCell.innerHTML = buildCategorySelect(categoryName);

        if (originalSpan > 1) {
            const table = categoryCell.closest('table');
            const allRows = Array.from(table.querySelectorAll('tbody tr'));
            const startIdx = allRows.indexOf(groupFirstRow);

            for (let i = 1; i < originalSpan; i++) {
                const siblingRow = allRows[startIdx + i];
                if (!siblingRow) continue;

                const newTd = document.createElement('td');
                newTd.className = 'category-cell injected-category-cell';

                newTd.innerHTML = `<span class="category-display">${categoryName}</span>`;

                siblingRow.insertBefore(newTd, siblingRow.firstElementChild);
            }
        }
    }

    function buildCategorySelect(selectedCategory) {
        const options = Array.from(document.querySelectorAll('#categoryInput option'))
            .filter(o => o.value !== '')
            .map(o => `<option value="${o.value}" ${o.value === selectedCategory ? 'selected' : ''}>${o.textContent}</option>`)
            .join('');
        return `<select class="category-select" style="font-size:12px; padding:3px 4px; border:1px solid #007bff; border-radius:3px; width:90%;">${options}</select>`;
    }

    function collapseCategoryRowspan(targetRow) {
        const table = targetRow.closest('table');

        // data-original-span이 있는 원본 셀을 테이블 전체에서 탐색
        const originalCell = table.querySelector('.category-cell[data-original-span]');
        if (!originalCell) return;

        const originalSpan = parseInt(originalCell.dataset.originalSpan);
        const originalCategory = originalCell.dataset.originalCategory;

        // 주입된 셀 먼저 제거 (DOM 변경 전에)
        table.querySelectorAll('.injected-category-cell').forEach(el => el.remove());

        // 원본 셀 복구 — span + select 구조 재건
        originalCell.rowSpan = originalSpan;
        const selectOptions = Array.from(document.querySelectorAll('#categoryInput option'))
            .filter(o => o.value !== '')
            .map(o => `<option value="${o.value}" ${o.value === originalCategory ? 'selected' : ''}>${o.textContent}</option>`)
            .join('');
        originalCell.innerHTML = `
            <span class="category-display">${originalCategory}</span>
            <select class="category-select" style="display:none;">${selectOptions}</select>`;
        delete originalCell.dataset.originalSpan;
        delete originalCell.dataset.originalCategory;
    }

    function saveProductPrice(button) {
        const productId = button.dataset.productId;
        const row = button.closest('tr');
        const priceCells = row.querySelectorAll(`.editable-price-cell[data-product-id="${productId}"]`);
        const pricePayload = {};

        priceCells.forEach(cell => {
            const input = cell.querySelector('.price-input');
            const priceType = cell.dataset.priceType;
            const newValue = parseFloat(input.value);
            const originalValue = parseFloat(cell.dataset.originalValue);
            if (!isNaN(newValue) && newValue !== originalValue) {
                if (priceType === 'cost') pricePayload.costPrice = newValue;
                if (priceType === 'supply') pricePayload.supplyPrice = newValue;
            }
        });

        // 이 행의 분류 select에서 값 읽기
        const categorySelect = row.querySelector('.category-select');
        let categoryChanged = false;
        let newCategory = null;
        if (categorySelect) {
            const categoryCell = row.querySelector('.category-cell');
            const originalCategory = categoryCell?.dataset.originalCategory
                || categoryCell?.textContent.trim();
            newCategory = categorySelect.value;
            if (newCategory !== originalCategory) categoryChanged = true;
        }

        if (Object.keys(pricePayload).length === 0 && !categoryChanged) {
            showAlert('변경된 값이 없습니다.', 'info');
            return;
        }

        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        const requests = [];

        if (Object.keys(pricePayload).length > 0) {
            requests.push(
                fetch(`/admin/products/${productId}/update-price`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', [csrfHeader]: csrfToken },
                    body: JSON.stringify(pricePayload)
                }).then(r => r.json())
            );
        }

        if (categoryChanged) {
            requests.push(
                fetch(`/admin/products/${productId}/update-category`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', [csrfHeader]: csrfToken },
                    body: JSON.stringify({ category: newCategory })
                }).then(r => r.json())
            );
        }

        Promise.all(requests)
            .then(results => {
                if (results.every(r => r.success)) {
                    showAlert('수정되었습니다.', 'success');
                    setTimeout(() => location.reload(), 800);
                } else {
                    showAlert('일부 수정에 실패했습니다.', 'error');
                }
            })
            .catch(() => showAlert('네트워크 오류가 발생했습니다.', 'error'));
    }

    function cancelEditPrice(button) {
        const productId = button.dataset.productId;
        const row = button.closest('tr');

        // 원가/판매가 원복
        const priceCells = row.querySelectorAll(`.editable-price-cell[data-product-id="${productId}"]`);
        priceCells.forEach(cell => {
            const display = cell.querySelector('.price-display');
            const input = cell.querySelector('.price-input');
            const originalValue = parseFloat(cell.dataset.originalValue);
            input.value = originalValue;
            display.textContent = Number(originalValue).toLocaleString('ko-KR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            input.style.display = 'none';
            display.style.display = 'inline-block';
        });

        // rowspan 원복
        collapseCategoryRowspan(row);

        resetPriceButtons(row, productId);
    }

    function resetPriceButtons(row, productId) {
        row.querySelector(`.edit-price-btn[data-product-id="${productId}"]`).style.display = 'inline-block';
        row.querySelector(`.save-price-btn[data-product-id="${productId}"]`).style.display = 'none';
        row.querySelector(`.cancel-price-btn[data-product-id="${productId}"]`).style.display = 'none';
    }

    // ===== 분류 관리 =====

    // 현재 분류 목록 (productsByCategory에서 수집)
    function getExistingCategories() {
      return Array.from(document.querySelectorAll("#categoryInput option"))
        .map(o => o.value).filter(v => v !== "");
    }

    // 각 분류의 제품 수 (category-cell rowspan 기준)
    function getProductCountByCategory(categoryName) {
      const cells = document.querySelectorAll('.category-cell');
      for (const cell of cells) {
        if (cell.querySelector('.category-display')?.textContent.trim() === categoryName) {
          return parseInt(cell.rowSpan) || 1;
        }
      }
      return 0;
    }

    function toggleCategoryForm() {
      const form = document.getElementById("categoryForm");
      const isHidden = form.style.display === "none";
      form.style.display = isHidden ? "block" : "none";
      if (isHidden) renderCategoryManageList();
      else document.getElementById("newCategoryInput").value = "";
    }

    function renderCategoryManageList() {
      const tbody = document.getElementById("categoryManageList");
      tbody.innerHTML = "";
      const categories = getExistingCategories();

      if (categories.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="padding:20px; text-align:center; color:#6c757d;">등록된 분류가 없습니다.</td></tr>';
        return;
      }

      categories.forEach(cat => {
        const count = getProductCountByCategory(cat);
        const tr = document.createElement("tr");
        tr.style.borderBottom = "1px solid #dee2e6";
        tr.innerHTML = `
          <td style="padding:10px; font-weight:600;">${cat}</td>
          <td style="padding:10px; text-align:center;">${count}</td>
          <td style="padding:10px;">
            <div style="display:flex; gap:6px; align-items:center;">
              <input type="text" class="form-input" value="${cat}"
                style="max-width:150px; padding:4px 8px; font-size:13px;"
                data-original="${cat}" />
              <button class="btn btn-sm btn-primary" onclick="renameCategoryFromPanel(this)">변경</button>
            </div>
          </td>
          <td style="padding:10px; text-align:center;">
            <button class="btn btn-sm btn-outline" 
              style="${count > 0 ? 'opacity:0.4; cursor:not-allowed;' : 'color:#dc3545; border-color:#dc3545;'}"
              ${count > 0 ? 'disabled title="사용 중인 분류는 삭제할 수 없습니다"' : `onclick="deleteCategory('${cat}')"`}>
              삭제
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function submitNewCategory() {
      const name = document.getElementById("newCategoryInput").value.trim();
      if (!name) { showAlert("분류명을 입력하세요.", "error"); return; }

      const existing = getExistingCategories();
      if (existing.includes(name)) {
        showAlert("이미 존재하는 분류입니다.", "error"); return;
      }

      // 제품 등록 select와 분류 수정 select에 옵션 추가
      [document.getElementById("categoryInput"), ...document.querySelectorAll(".category-select")]
        .forEach(sel => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          sel.appendChild(opt);
        });

      document.getElementById("newCategoryInput").value = "";
      showAlert(`'${name}' 분류가 추가되었습니다. 제품에 배정하면 저장됩니다.`, "success");
      renderCategoryManageList();
    }

    function renameCategoryFromPanel(button) {
      const input = button.previousElementSibling;
      const oldName = input.dataset.original;
      const newName = input.value.trim();

      if (!newName) { showAlert("분류명을 입력하세요.", "error"); return; }
      if (newName === oldName) { showAlert("변경된 내용이 없습니다.", "info"); return; }

      const existing = getExistingCategories();
      if (existing.includes(newName)) {
        showAlert("이미 존재하는 분류명입니다.", "error"); return;
      }

      const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

      fetch('/admin/products/categories/rename', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', [csrfHeader]: csrfToken },
        body: JSON.stringify({ oldName, newName })
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          showAlert(`'${oldName}' → '${newName}' 변경 완료 (${data.count}개 제품)`, "success");
          setTimeout(() => location.reload(), 1000);
        } else {
          showAlert("변경 실패: " + data.message, "error");
        }
      })
      .catch(() => showAlert("네트워크 오류가 발생했습니다.", "error"));
    }

    function deleteCategory(categoryName) {
      // 제품 수가 0인 경우만 여기 도달 (버튼이 disabled)
      // select에서 옵션 제거 (DB엔 저장된 것 없으므로 UI만)
      [document.getElementById("categoryInput"), ...document.querySelectorAll(".category-select")]
        .forEach(sel => {
          const opt = Array.from(sel.options).find(o => o.value === categoryName);
          if (opt) sel.removeChild(opt);
        });

      showAlert(`'${categoryName}' 분류가 삭제되었습니다.`, "success");
      renderCategoryManageList();
    }
    </script>

    <style>
      .action-header {
        margin: 20px 0;
        text-align: right;
      }

      .form-table-container {
        overflow-x: auto;
        margin-bottom: 20px;
      }

      .form-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        min-width: 800px;
      }

      .form-table th,
      .form-table td {
        border: 1px solid #dee2e6;
        padding: 12px;
        text-align: center;
      }

      .form-header {
        background: #162b4d;
        color: white;
        font-weight: bold;
      }

      .form-cell {
        background: #f8f9fa;
      }

      .form-input {
        width: 100%;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 8px;
        font-size: 14px;
      }

      .product-table-container {
        overflow-x: auto;
        margin-bottom: 20px;
      }

      .product-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        min-width: 1000px;
      }

      .product-table th,
      .product-table td {
        border: 1px solid #dee2e6;
        padding: 8px 12px;
        text-align: center;
      }

      .product-header {
        background: #2c5aa0;
        color: white;
        font-weight: bold;
      }

      .category-cell {
        background: #d3d3d3;
        color: #333;
        font-weight: bold;
        vertical-align: middle;
        text-align: center;
      }

      #categoryForm table th,
      #categoryForm table td {
        text-align: center;
      }

      #categoryForm table tbody td:nth-child(3) > div {
        justify-content: center;
      }

      /* 카테고리별 배경색 (연한 초록색 계열) */
      .data-cell.green-1 {
        background: #d4f4d4;
      }

      .data-cell.green-2 {
        background: #c0f0c0;
      }

      .data-cell.green-3 {
        background: #e8f5e8;
      }

      .data-cell.green-4 {
        background: #b3e6b3;
      }

      /* 비활성 제품 스타일 */
      .data-cell.inactive {
        background: #f5f5f5 !important;
        color: #999;
      }

      .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
      }

      .status-active {
        background: #d1e7dd;
        color: #0f5132;
      }

      .status-inactive {
        background: #f8d7da;
        color: #721c24;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin: 2px;
      }

      .btn-primary {
        background: #007bff;
        color: white;
      }

      .btn-primary:hover {
        background: #0056b3;
      }

      .btn-success {
        background: #28a745;
        color: white;
      }

      .btn-success:hover {
        background: #218838;
      }

      .btn-outline {
        background: white;
        border: 1px solid #6c757d;
        color: #6c757d;
      }

      .btn-outline:hover {
        background: #6c757d;
        color: white;
      }

      .btn-sm {
        padding: 4px 8px;
        font-size: 12px;
      }

      .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin: 20px 0;
      }

      .card-header {
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 15px;
        margin-bottom: 20px;
      }

      .card-title {
        margin: 0;
        color: #2c3e50;
      }

      .alert {
        padding: 12px 16px;
        margin: 10px 0;
        border-radius: 4px;
        position: relative;
      }

      .alert-success {
        background: #d1e7dd;
        color: #0f5132;
        border: 1px solid #badbcc;
      }

      .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .alert-info {
        background: #cff4fc;
        color: #055160;
        border: 1px solid #b6effb;
      }

      /* 반응형 레이아웃 */
      @media (max-width: 768px) {
        .form-table-container,
        .product-table-container {
          margin: 0 -20px;
          padding: 0 20px;
        }

        .action-header {
          text-align: center;
        }
      }

      .nav-item {
        position: relative;
      }

      .sub-menu {
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        min-width: 150px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        border-radius: 4px;
        z-index: 1000;
        display: none;
      }

      .nav-item:hover .sub-menu {
        display: block;
      }

      .sub-menu a {
        display: block;
        padding: 10px 15px;
        color: #333;
        text-decoration: none;
        border-bottom: 1px solid #eee;
      }

      .sub-menu a:last-child {
        border-bottom: none;
        border-radius: 0 0 4px 4px;
      }

      .sub-menu a:hover {
        background: #f8f9fa;
      }

      /* 가격 편집 관련 스타일 */
      .editable-price-cell {
          position: relative;
          padding: 8px 12px;
      }

      .price-display {
          display: inline-block;
      }

      .price-input {
          width: 100px;
          padding: 4px 8px;
          border: 2px solid #007bff;
          border-radius: 4px;
          font-size: 13px;
          text-align: right;
      }

      .price-input:focus {
          outline: none;
          border-color: #0056b3;
      }

      .btn-sm {
          padding: 4px 8px;
          font-size: 12px;
          margin-right: 4px;
      }

      .btn-primary {
          background: #007bff;
          color: white;
          border: 1px solid #007bff;
      }

      .btn-primary:hover {
          background: #0056b3;
          border-color: #0056b3;
      }

      .btn-success {
          background: #28a745;
          color: white;
          border: 1px solid #28a745;
      }

      .btn-success:hover {
          background: #218838;
          border-color: #218838;
      }

      .btn-secondary {
          background: #6c757d;
          color: white;
          border: 1px solid #6c757d;
      }

      .btn-secondary:hover {
          background: #5a6268;
          border-color: #5a6268;
      }

      /* ===== 가격 셀 툴팁 ===== */
      .editable-price-cell.tooltip {
        position: relative;
        cursor: pointer;
      }

      .editable-price-cell.tooltip:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 110%; /* 셀 위로 살짝 띄움 */
        left: 50%;
        transform: translateX(-50%);
        background: rgba(33, 37, 41, 0.95); /* 어두운 반투명 배경 */
        color: #fff;
        padding: 6px 10px;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 9999;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        pointer-events: none; /* 마우스가 툴팁 위에 올라가도 사라지지 않게 */
      }

      .editable-price-cell.tooltip:hover::before {
        content: "";
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        border-width: 5px;
        border-style: solid;
        border-color: rgba(33, 37, 41, 0.95) transparent transparent transparent;
      }

      .disabled-button {
        opacity: 0.5;
        pointer-events: none;
        cursor: default;
      }

            .change-password-link {
        color: white;
        text-decoration: none;
        padding: 6px 12px;
        border: 1px solid white;
        border-radius: 4px;
        font-size: 14px;
        transition: background-color 0.2s;
        margin-right: 10px;
        display: inline-block;
      }

      .change-password-link:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }
    </style>
  </body>
</html>