<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <title>제품 분류 관리 - 마이넷 매출 관리 시스템</title>
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <script th:src="@{/js/common.js}" defer></script>
  </head>
  <body>
    <!-- 헤더 -->
    <header class="header">
      <div class="header-content">
        <div class="logo">마이넷 매출 관리 시스템</div>
        <div class="user-info">
          <span
            class="user-name"
            th:text="${#authentication.principal.companyName}"
            >마이넷</span
          >
          <span class="user-role">(마이넷)</span>
          <form th:action="@{/logout}" method="post" style="display: inline">
            <button type="submit" class="logout-btn">로그아웃</button>
          </form>
        </div>
      </div>
    </header>

    <!-- 네비게이션 -->
    <nav class="nav-menu">
      <div class="nav-content">
        <div
          class="nav-item"
          th:classappend="${currentPage == 'view'} ? 'active'"
        >
          <a th:href="@{/mynet/view}">조회</a>
        </div>

        <div
          class="nav-item"
          th:classappend="${currentPage == 'compare'} ? 'active'"
        >
          <a href="javascript:void(0)">비교 ▼</a>
          <div class="sub-menu">
            <a
              th:href="@{/mynet/compare/monthly}"
              th:classappend="${comparePage == 'monthly'} ? 'active'"
              >월별</a
            >
            <a
              th:href="@{/mynet/compare/yearly}"
              th:classappend="${comparePage == 'yearly'} ? 'active'"
              >년도별</a
            >
            <a
              th:href="@{/mynet/compare/period}"
              th:classappend="${comparePage == 'period'} ? 'active'"
              >기간별</a
            >
            <a
              th:href="@{/mynet/compare/product}"
              th:classappend="${comparePage == 'product'} ? 'active'"
              >제품별</a
            >
          </div>
        </div>

        <div
          class="nav-item"
          th:classappend="${currentPage == 'products'} ? 'active'"
        >
          <a th:href="@{/admin/products}">제품 분류</a>
        </div>

        <div
          class="nav-item"
          th:classappend="${currentPage == 'users'} ? 'active'"
          th:if="${!isCanon}"
        >
          <a th:href="@{/admin/users}">사용자 관리</a>
        </div>
      </div>
    </nav>

    <!-- 메인 컨텐츠 -->
    <main class="main-container">
      <div id="alert-container"></div>

      <!-- 제품 등록 버튼 -->
      <div class="action-header">
        <button
          class="btn btn-primary"
          id="addProductBtn"
          onclick="toggleProductForm()"
        >
          제품 등록
        </button>
      </div>

      <!-- 제품 등록 폼 (숨김 상태) -->
      <div class="card" id="productForm" style="display: none">
        <div class="card-header">
          <h3 class="card-title">새 제품 등록</h3>
        </div>
        <form id="productRegistrationForm">
          <div class="form-table-container">
            <table class="form-table">
              <thead>
                <tr>
                  <th class="form-header">분류</th>
                  <th class="form-header">제품코드</th>
                  <th class="form-header">제품명</th>
                  <th class="form-header">원가</th>
                  <th class="form-header">판매가</th>
                  <th class="form-header">액션</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="form-cell">
                    <input
                      list="categories"
                      class="form-input"
                      id="categoryInput"
                      placeholder="분류 선택 또는 입력"
                      required
                    />
                    <datalist id="categories">
                      <option
                        th:each="category : ${existingCategories}"
                        th:value="${category}"
                        th:text="${category}"
                      ></option>
                    </datalist>
                  </td>
                  <td class="form-cell">
                    <input
                      type="text"
                      class="form-input"
                      id="productCodeInput"
                      th:value="${nextProductCode}"
                      readonly
                    />
                  </td>
                  <td class="form-cell">
                    <input
                      type="text"
                      class="form-input"
                      id="productNameInput"
                      placeholder="제품명 입력"
                      required
                    />
                  </td>
                  <td class="form-cell">
                    <input
                      type="number"
                      class="form-input"
                      id="costPriceInput"
                      placeholder="원가"
                      step="0.01"
                      min="0"
                      required
                    />
                  </td>
                  <td class="form-cell">
                    <input
                      type="number"
                      class="form-input"
                      id="supplyPriceInput"
                      placeholder="판매가"
                      step="0.01"
                      min="0"
                      required
                    />
                  </td>
                  <td class="form-cell">
                    <button type="submit" class="btn btn-success">등록</button>
                    <button
                      type="button"
                      class="btn btn-outline"
                      onclick="cancelProductForm()"
                    >
                      취소
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </form>
      </div>

      <!-- 제품 목록 테이블 -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">제품 목록</h3>
        </div>
        <div class="product-table-container">
          <table class="product-table" id="productListTable">
            <thead>
              <tr>
                <th class="product-header">분류</th>
                <th class="product-header">제품코드</th>
                <th class="product-header">제품명</th>
                <th class="product-header">원가</th>
                <th class="product-header">판매가</th>
                <th class="product-header">상태</th>
                <th class="product-header">등록일</th>
                <th class="product-header">액션</th>
              </tr>
            </thead>
            <tbody id="productTableBody">
              <!-- 카테고리별로 그룹화된 제품 목록 -->
              <th:block
                th:each="categoryGroup, categoryGroupStat : ${productsByCategory}"
              >
                <!-- 각 카테고리의 제품들 -->
                <th:block
                  th:each="product, productStat : ${categoryGroup.value}"
                >
                  <tr th:if="${productStat.first}">
                    <!-- 첫 번째 제품의 경우 카테고리 셀 포함 -->
                    <td
                      class="category-cell"
                      th:rowspan="${categoryGroup.value.size()}"
                      th:text="${categoryGroup.key}"
                    ></td>
                    <td
                      class="data-cell"
                      th:text="${product.productCode}"
                      th:class="'data-cell ' + ${product.categoryClass} + (${!product.active} ? ' inactive' : '')"
                    ></td>
                    <td
                      class="data-cell"
                      th:text="${product.productName}"
                      th:class="'data-cell ' + ${product.categoryClass} + (${!product.active} ? ' inactive' : '')"
                    ></td>
                    <td
                      class="data-cell"
                      th:text="${#numbers.formatDecimal(product.currentCostPrice, 0, 'COMMA', 2, 'POINT')}"
                      th:class="'data-cell ' + ${product.categoryClass} + (${!product.active} ? ' inactive' : '')"
                    ></td>
                    <td
                      class="data-cell"
                      th:text="${#numbers.formatDecimal(product.currentSupplyPrice, 0, 'COMMA', 2, 'POINT')}"
                      th:class="'data-cell ' + ${product.categoryClass} + (${!product.active} ? ' inactive' : '')"
                    ></td>
                    <td
                      class="data-cell"
                      th:class="'data-cell ' + ${product.categoryClass} + (${!product.active} ? ' inactive' : '')"
                    >
                      <span
                        class="status-badge"
                        th:class="${product.active ? 'status-active' : 'status-inactive'}"
                        th:text="${product.active ? '활성' : '비활성'}"
                      ></span>
                    </td>
                    <td
                      class="data-cell"
                      th:text="${#temporals.format(product.createdAt, 'yyyy-MM-dd')}"
                      th:class="'data-cell ' + ${product.categoryClass} + (${!product.active} ? ' inactive' : '')"
                    ></td>
                    <td
                      class="data-cell"
                      th:class="'data-cell ' + ${product.categoryClass} + (${!product.active} ? ' inactive' : '')"
                    >
                      <button
                        class="btn btn-sm btn-outline"
                        th:onclick="'toggleProductStatus(' + ${product.id} + ', ' + ${product.active} + ')'"
                        th:text="${product.active ? '비활성화' : '활성화'}"
                      ></button>
                    </td>
                  </tr>
                  <tr th:unless="${productStat.first}">
                    <!-- 나머지 제품들 -->
                    <td
                      class="data-cell"
                      th:text="${product.productCode}"
                      th:class="'data-cell ' + ${product.categoryClass} + (${!product.active} ? ' inactive' : '')"
                    ></td>
                    <td
                      class="data-cell"
                      th:text="${product.productName}"
                      th:class="'data-cell ' + ${product.categoryClass} + (${!product.active} ? ' inactive' : '')"
                    ></td>
                    <td
                      class="data-cell"
                      th:text="${#numbers.formatDecimal(product.currentCostPrice, 0, 'COMMA', 2, 'POINT')}"
                      th:class="'data-cell ' + ${product.categoryClass} + (${!product.active} ? ' inactive' : '')"
                    ></td>
                    <td
                      class="data-cell"
                      th:text="${#numbers.formatDecimal(product.currentSupplyPrice, 0, 'COMMA', 2, 'POINT')}"
                      th:class="'data-cell ' + ${product.categoryClass} + (${!product.active} ? ' inactive' : '')"
                    ></td>
                    <td
                      class="data-cell"
                      th:class="'data-cell ' + ${product.categoryClass} + (${!product.active} ? ' inactive' : '')"
                    >
                      <span
                        class="status-badge"
                        th:class="${product.active ? 'status-active' : 'status-inactive'}"
                        th:text="${product.active ? '활성' : '비활성'}"
                      ></span>
                    </td>
                    <td
                      class="data-cell"
                      th:text="${#temporals.format(product.createdAt, 'yyyy-MM-dd')}"
                      th:class="'data-cell ' + ${product.categoryClass} + (${!product.active} ? ' inactive' : '')"
                    ></td>
                    <td
                      class="data-cell"
                      th:class="'data-cell ' + ${product.categoryClass} + (${!product.active} ? ' inactive' : '')"
                    >
                      <button
                        class="btn btn-sm btn-outline"
                        th:onclick="'toggleProductStatus(' + ${product.id} + ', ' + ${product.active} + ')'"
                        th:text="${product.active ? '비활성화' : '활성화'}"
                      ></button>
                    </td>
                  </tr>
                </th:block>
              </th:block>
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <script>
      // 제품 등록 폼 토글
      function toggleProductForm() {
        const form = document.getElementById("productForm");
        const btn = document.getElementById("addProductBtn");

        if (form.style.display === "none" || form.style.display === "") {
          form.style.display = "block";
          btn.textContent = "등록 취소";
          btn.classList.remove("btn-primary");
          btn.classList.add("btn-outline");
        } else {
          cancelProductForm();
        }
      }

      // 제품 등록 폼 취소
      function cancelProductForm() {
        const form = document.getElementById("productForm");
        const btn = document.getElementById("addProductBtn");
        const formElement = document.getElementById("productRegistrationForm");

        form.style.display = "none";
        btn.textContent = "제품 등록";
        btn.classList.remove("btn-outline");
        btn.classList.add("btn-primary");
        formElement.reset();
      }

      // 제품 등록 폼 제출
      document
        .getElementById("productRegistrationForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const formData = {
            category: document.getElementById("categoryInput").value,
            productCode: document.getElementById("productCodeInput").value,
            productName: document.getElementById("productNameInput").value,
            costPrice: parseFloat(
              document.getElementById("costPriceInput").value
            ),
            supplyPrice: parseFloat(
              document.getElementById("supplyPriceInput").value
            ),
          };

          // AJAX로 제품 등록
          const xhr = new XMLHttpRequest();
          xhr.open("POST", "/admin/products/register", true);
          xhr.setRequestHeader("Content-Type", "application/json");

          const csrfToken = document.querySelector('meta[name="_csrf"]');
          if (csrfToken) {
            xhr.setRequestHeader(
              document
                .querySelector('meta[name="_csrf_header"]')
                .getAttribute("content"),
              csrfToken.getAttribute("content")
            );
          }

          xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
              if (xhr.status === 200) {
                showAlert("제품이 등록되었습니다.", "success");
                setTimeout(() => {
                  location.reload();
                }, 1000);
              } else {
                showAlert("제품 등록 중 오류가 발생했습니다.", "error");
              }
            }
          };

          xhr.send(JSON.stringify(formData));
        });

      // 제품 상태 토글 (활성/비활성)
      function toggleProductStatus(productId, currentStatus) {
        const action = currentStatus ? "deactivate" : "activate";
        const message = currentStatus ? "비활성화" : "활성화";

        if (confirm(`정말로 이 제품을 ${message}하시겠습니까?`)) {
          const xhr = new XMLHttpRequest();
          xhr.open("POST", `/admin/products/${productId}/${action}`, true);

          const csrfToken = document.querySelector('meta[name="_csrf"]');
          if (csrfToken) {
            xhr.setRequestHeader(
              document
                .querySelector('meta[name="_csrf_header"]')
                .getAttribute("content"),
              csrfToken.getAttribute("content")
            );
          }

          xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
              if (xhr.status === 200) {
                showAlert(`제품이 ${message}되었습니다.`, "success");
                setTimeout(() => {
                  location.reload();
                }, 1000);
              } else {
                showAlert(`제품 ${message} 중 오류가 발생했습니다.`, "error");
              }
            }
          };

          xhr.send();
        }
      }

      // 알림 표시
      function showAlert(message, type = "info") {
        const container = document.getElementById("alert-container");
        const alert = document.createElement("div");
        alert.className = `alert alert-${type}`;
        alert.textContent = message;

        const closeBtn = document.createElement("button");
        closeBtn.innerHTML = "×";
        closeBtn.onclick = () => alert.remove();
        alert.appendChild(closeBtn);

        container.appendChild(alert);
        setTimeout(() => alert.remove(), 3000);
      }
    </script>

    <style>
      .action-header {
        margin: 20px 0;
        text-align: right;
      }

      .form-table-container {
        overflow-x: auto;
        margin-bottom: 20px;
      }

      .form-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        min-width: 800px;
      }

      .form-table th,
      .form-table td {
        border: 1px solid #dee2e6;
        padding: 12px;
        text-align: center;
      }

      .form-header {
        background: #162b4d;
        color: white;
        font-weight: bold;
      }

      .form-cell {
        background: #f8f9fa;
      }

      .form-input {
        width: 100%;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 8px;
        font-size: 14px;
      }

      .product-table-container {
        overflow-x: auto;
        margin-bottom: 20px;
      }

      .product-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        min-width: 1000px;
      }

      .product-table th,
      .product-table td {
        border: 1px solid #dee2e6;
        padding: 8px 12px;
        text-align: center;
      }

      .product-header {
        background: #2c5aa0;
        color: white;
        font-weight: bold;
      }

      .category-cell {
        background: #d3d3d3;
        color: #333;
        font-weight: bold;
        vertical-align: middle;
        text-align: center;
      }

      /* 카테고리별 배경색 (연한 초록색 계열) */
      .data-cell.green-1 {
        background: #e8f5e8;
      }

      .data-cell.green-2 {
        background: #d4f4d4;
      }

      .data-cell.green-3 {
        background: #c0f0c0;
      }

      .data-cell.green-4 {
        background: #b3e6b3;
      }

      /* 비활성 제품 스타일 */
      .data-cell.inactive {
        background: #f5f5f5 !important;
        color: #999;
      }

      .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
      }

      .status-active {
        background: #d1e7dd;
        color: #0f5132;
      }

      .status-inactive {
        background: #f8d7da;
        color: #721c24;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin: 2px;
      }

      .btn-primary {
        background: #007bff;
        color: white;
      }

      .btn-primary:hover {
        background: #0056b3;
      }

      .btn-success {
        background: #28a745;
        color: white;
      }

      .btn-success:hover {
        background: #218838;
      }

      .btn-outline {
        background: white;
        border: 1px solid #6c757d;
        color: #6c757d;
      }

      .btn-outline:hover {
        background: #6c757d;
        color: white;
      }

      .btn-sm {
        padding: 4px 8px;
        font-size: 12px;
      }

      .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin: 20px 0;
      }

      .card-header {
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 15px;
        margin-bottom: 20px;
      }

      .card-title {
        margin: 0;
        color: #2c3e50;
      }

      .alert {
        padding: 12px 16px;
        margin: 10px 0;
        border-radius: 4px;
        position: relative;
      }

      .alert-success {
        background: #d1e7dd;
        color: #0f5132;
        border: 1px solid #badbcc;
      }

      .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      /* 반응형 레이아웃 */
      @media (max-width: 768px) {
        .form-table-container,
        .product-table-container {
          margin: 0 -20px;
          padding: 0 20px;
        }

        .action-header {
          text-align: center;
        }
      }

      .nav-item {
        position: relative;
      }

      .sub-menu {
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        min-width: 150px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        border-radius: 4px;
        z-index: 1000;
        display: none;
      }

      .nav-item:hover .sub-menu {
        display: block;
      }

      .sub-menu a {
        display: block;
        padding: 10px 15px;
        color: #333;
        text-decoration: none;
        border-bottom: 1px solid #eee;
      }

      .sub-menu a:last-child {
        border-bottom: none;
        border-radius: 0 0 4px 4px;
      }

      .sub-menu a:hover {
        background: #f8f9fa;
      }
    </style>
  </body>
</html>
