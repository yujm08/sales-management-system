<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>하위 회사 입력 - 마이넷 매출 관리 시스템</title>
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <link rel="stylesheet" th:href="@{/css/datepicker.css}" />
    <script th:src="@{/js/datepicker.js}"></script>
    <style>
        /* 전체 스타일 */
        .main-container {
            padding: 20px;
            background: #f8f9fa;
            min-height: 100vh;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* 상단 컨트롤 영역 */
        .control-panel {
            background: #e9ecef;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* 기준 날짜 영역 */
        .date-control-inline {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            justify-content: center;
            color: #495057;
            font-weight: 500;
            font-size: 14px;
        }

        .date-control-inline .label {
            margin-right: 4px;
            color: #6c757d;
        }

        .date-control-inline .date-nav-btn {
            background: transparent;
            border: 1px solid #adb5bd;
            color: #495057;
            padding: 3px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
        }

        .date-control-inline .date-nav-btn:hover {
            background: #f1f3f5;
        }

        .date-control-inline .current-date {
            font-weight: 600;
            color: #212529;
            padding: 3px 6px;
            border: 1px solid transparent;
            border-radius: 3px;
            cursor: pointer;
        }

        .date-control-inline .current-date:hover {
            border-color: #ced4da;
            background: #f8f9fa;
        }

        .date-picker {
            position: absolute;
            left: -9999px;
            opacity: 0;
        }

        /* 버튼 스타일 */
        .btn {
            padding: 8px 16px;
            border: 1px solid #6c757d;
            background: white;
            color: #495057;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn:hover {
            background: #f8f9fa;
        }

        .btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .btn-primary {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .btn-primary:hover {
            background: #218838;
            border-color: #218838;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border-color: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
            border-color: #5a6268;
        }

        /* 테이블 스타일 */
        .table-container {
            overflow-x: auto;
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            background: white;
        }

        .stats-table th {
            background: #24595e;
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #ffffff;
            font-size: 12px;
        }

        .stats-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #ffffff;
            font-size: 12px;
        }

        /* 카테고리 셀 스타일 */
        .category-cell {
            background: #dee2e6;
            color: #333;
            font-weight: bold;
            vertical-align: middle;
            text-align: center;
        }

        /* 카테고리별 배경색 */
        .data-cell.green-1 {
            background: #e8f5e8;
        }

        .data-cell.green-2 {
            background: #d4f4d4;
        }

        .data-cell.green-3 {
            background: #c0f0c0;
        }

        .data-cell.green-4 {
            background: #b3e6b3;
        }

        /* 수량 입력 셀 */
        .quantity-cell {
            background-color: #fff3cd !important;
            vertical-align: middle;
            text-align: left;
            padding-left: 10px;
        }

        .quantity-cell.editable {
            background-color: #ffeaa7 !important;
            cursor: pointer;
        }

        .quantity-input {
            width: 70px;
            text-align: center;
            border: 1px solid #ced4da;
            border-radius: 3px;
            padding: 4px 8px;
            background: transparent;
            font-size: 12px;
            line-height: normal;
            height: 28px;
            box-sizing: border-box;
            display: block;
            margin: 0;
        }

        .quantity-input:read-only {
            border-color: transparent;
            background: transparent;
        }

        .quantity-input.editable {
            background: white;
            border-color: #007bff;
        }

        /* 소계/합계 행 */
        .subtotal-row td {
            background-color: #f1f3f5 !important;
            font-weight: 600;
        }

        .total-row td {
            background-color: #d3d3d3 !important;
            font-weight: 700;
            font-size: 13px;
        }

        /* 제품 정보 */
        .product-info {
            text-align: left;
            padding-left: 10px;
        }

        .product-name {
            font-weight: 600;
            font-size: 12px;
        }

        /* 수치 표시 */
        .amount {
            font-weight: 600;
            color: #000000;
            text-align: right;
            padding-right: 10px;
        }

        /* 알림 */
        .alert {
            padding: 12px 16px;
            margin-bottom: 16px;
            border-radius: 4px;
            font-weight: 500;
        }

        .alert-success {
            background-color: #d1edff;
            color: #0c5460;
            border: 1px solid #28a745;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #dc3545;
        }

        /* 버튼 컨테이너 */
        .button-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }
    </style>
</head>
<body>
    <!-- 헤더 -->
    <header class="header">
        <div class="header-content">
            <div class="logo">마이넷 매출 관리 시스템</div>
            <div class="user-info">
                <span class="user-name" th:text="${companyName}">영현아이앤씨</span>
                <span class="user-role">(사용자)</span>
                <form th:action="@{/logout}" method="post" style="display: inline">
                    <button type="submit" class="logout-btn">로그아웃</button>
                </form>
            </div>
        </div>
    </header>

    <!-- 네비게이션 -->
    <nav class="nav-menu">
        <div class="nav-content">
            <div class="nav-item active">
                <a th:href="@{/subsidiary/input}">입력</a>
            </div>
            <div class="nav-item">
                <a th:href="@{/subsidiary/view}">조회</a>
            </div>
            <div class="nav-item">
                <a th:href="@{/subsidiary/monthly}">월별매출집계</a>
            </div>
        </div>
    </nav>

    <!-- 메인 컨텐츠 -->
    <main class="main-container">
        <div id="alert-container"></div>

        <div class="card">
            <!-- 상단 컨트롤 영역 -->
            <div class="control-panel">
                <div style="width: 100px;"></div> <!-- 좌측 공간 -->
                
                <!-- 기준 날짜 영역 (중앙) -->
                <div class="date-control-inline">
                    <span>기준 날짜 : </span>
                    <button class="date-nav-btn" onclick="changeDate(-1)">◀</button>
                    <span class="current-date" id="current-date" onclick="showDatePicker()"
                        th:text="${#temporals.format(currentDate, 'yyyy-MM-dd')}">2025-01-15</span>
                    <button class="date-nav-btn" onclick="changeDate(1)">▶</button>
                    <input type="date" class="date-picker" id="date-picker" 
                        th:value="${currentDate}" onchange="selectDate()">
                </div>

                <!-- 수정 버튼 (우측) -->
                <div class="button-container">
                    <button class="btn" id="editBtn" onclick="toggleEdit()" 
                            th:style="${!isCurrentMonth} ? 'display: none;' : ''">수정</button>
                    <button class="btn btn-primary" id="saveBtn" onclick="saveSalesData()" 
                            style="display: none;">저장</button>
                    <button class="btn btn-secondary" id="cancelBtn" onclick="cancelEdit()" 
                            style="display: none;">취소</button>
                </div>
            </div>

            <!-- 테이블 -->
            <div class="table-container">
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th colspan="4">제품</th>
                            <th rowspan="2">수량</th>
                        </tr>
                        <tr>
                            <th>분류</th>
                            <th>제품코드</th>
                            <th>제품명</th>
                            <th>공급가</th>
                        </tr>
                    </thead>
                    <tbody id="stats-tbody">
                        <!-- 데이터가 없는 경우 -->
                        <tr th:if="${#maps.isEmpty(productsByCategory)}">
                            <td colspan="5" style="text-align: center; padding: 40px; color: #6c757d">
                                표시할 데이터가 없습니다.
                            </td>
                        </tr>

                        <!-- 카테고리별 제품 데이터 -->
                        <th:block th:each="categoryEntry, categoryStat : ${productsByCategory}">
                            <!-- 각 카테고리의 제품들 -->
                            <th:block th:each="product, productStat : ${categoryEntry.value}">
                                <tr>
                                    <!-- 카테고리 셀 (첫 번째 제품에만 표시, rowspan) -->
                                    <td th:if="${productStat.first}"
                                        class="category-cell"
                                        th:rowspan="${#lists.size(categoryEntry.value)}"
                                        th:text="${categoryEntry.key}">분류</td>

                                    <!-- 제품 정보 -->
                                    <td th:class="'data-cell green-' + ${(categoryStat.index % 4) + 1}"
                                        th:text="${product.productCode}">제품코드</td>
                                    <td th:class="'data-cell green-' + ${(categoryStat.index % 4) + 1} + ' product-info'">
                                        <div class="product-name" th:text="${product.productName}">제품명</div>
                                    </td>
                                    <td th:class="'data-cell green-' + ${(categoryStat.index % 4) + 1} + ' amount'"
                                        th:text="${#numbers.formatInteger(product.supplyPrice, 0, 'COMMA')}">공급가</td>

                                    <!-- 수량 입력 셀 -->
                                    <td th:class="'data-cell green-' + ${(categoryStat.index % 4) + 1} + ' quantity-cell'"
                                        th:classappend="${isCurrentMonth ? 'editable' : ''}">
                                        <input type="number" 
                                               class="quantity-input" 
                                               th:value="${product.quantity}" 
                                               th:data-product-id="${product.id}"
                                               th:data-category="${categoryEntry.key}"
                                               th:data-supply-price="${product.supplyPrice}"
                                               th:data-editable="${isCurrentMonth}"
                                               readonly
                                               min="0"
                                               oninput="calculateTotals()">
                                    </td>
                                </tr>
                            </th:block>

                            <!-- 카테고리별 소계 행 -->
                            <tr class="subtotal-row">
                                <td colspan="3" style="text-align: left; padding-left: 15px">
                                    <strong th:text="${'소계'}">소계</strong>
                                </td>
                                <td class="amount" th:data-category-total-price="${categoryEntry.key}">0</td>
                                <td th:data-category-total-quantity="${categoryEntry.key}">0</td>
                            </tr>
                        </th:block>

                        <!-- 전체 합계 행 -->
                        <tr class="total-row" th:if="${!#maps.isEmpty(productsByCategory)}">
                            <td colspan="3" style="text-align: left; padding-left: 15px">
                                <strong>합계</strong>
                            </td>
                            <td class="amount" id="totalPrice">0</td>
                            <td id="totalQuantity">0</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script th:src="@{/js/common.js}"></script>

    <script>
        let currentDate = new Date();
        let isEditMode = false;
        let originalData = {};

        document.addEventListener("DOMContentLoaded", function() {
            // 현재 날짜 초기화
            const dateElement = document.getElementById('current-date');
            if (dateElement) {
                currentDate = new Date(dateElement.textContent);
            }

            // 날짜 피커 초기화
            if (typeof globalDatePicker !== 'undefined') {
                globalDatePicker.selectedDate = new Date(currentDate);
                globalDatePicker.init(document.getElementById('current-date'), {
                    currentYearOnly: true,
                    onSelect: function(dateString) {
                        location.href = '/subsidiary/input?date=' + dateString;
                    }
                });
            }

            calculateTotals();
        });

        // 날짜 변경
        function changeDate(days) {
            const newDate = new Date(currentDate);
            newDate.setDate(currentDate.getDate() + days);
            
            if (!isCurrentYear(newDate)) {
                showAlert('당년도 날짜만 선택할 수 있습니다.', 'error');
                return;
            }
            
            const dateString = formatDate(newDate);
            location.href = '/subsidiary/input?date=' + dateString;
        }

        // 날짜 피커 표시
        function showDatePicker() {
            if (window.globalDatePicker) {
                globalDatePicker.currentDate = new Date(currentDate);
                globalDatePicker.selectedDate = new Date(currentDate);
                globalDatePicker.show();
            } else {
                console.error("globalDatePicker가 준비되지 않았습니다.");
            }
        }

        // 수정 모드 토글
        function toggleEdit() {
            isEditMode = !isEditMode;
            const editBtn = document.getElementById('editBtn');
            const saveBtn = document.getElementById('saveBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const inputs = document.querySelectorAll('.quantity-input[data-editable="true"]');

            if (isEditMode) {
                editBtn.style.display = 'none';
                saveBtn.style.display = 'inline-block';
                cancelBtn.style.display = 'inline-block';
                
                inputs.forEach(input => {
                    input.readOnly = false;
                    input.classList.add('editable');
                    originalData[input.dataset.productId] = input.value;
                });
            } else {
                editBtn.style.display = 'inline-block';
                saveBtn.style.display = 'none';
                cancelBtn.style.display = 'none';
                
                inputs.forEach(input => {
                    input.readOnly = true;
                    input.classList.remove('editable');
                });
            }
        }

        // 취소
        function cancelEdit() {
            const inputs = document.querySelectorAll('.quantity-input[data-editable="true"]');
            
            inputs.forEach(input => {
                input.value = originalData[input.dataset.productId] || 0;
            });
            
            calculateTotals();
            toggleEdit();
        }

        // 저장
        function saveSalesData() {
            const quantities = {};
            const inputs = document.querySelectorAll('.quantity-input[data-editable="true"]');
            
            inputs.forEach(input => {
                const productId = parseInt(input.dataset.productId);
                const quantity = parseInt(input.value) || 0;
                quantities[productId] = quantity;
            });

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/subsidiary/input/save', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            
            const csrfToken = document.querySelector('meta[name="_csrf"]');
            if (csrfToken) {
                xhr.setRequestHeader(
                    document.querySelector('meta[name="_csrf_header"]').getAttribute('content'),
                    csrfToken.getAttribute('content')
                );
            }

            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        showAlert('저장되었습니다.', 'success');
                        toggleEdit();
                    } else {
                        showAlert('저장 중 오류가 발생했습니다.', 'error');
                    }
                }
            };

            xhr.send(JSON.stringify({
                date: formatDate(currentDate),
                quantities: quantities
            }));
        }

        // 총합계 계산
        function calculateTotals() {
            const inputs = document.querySelectorAll('.quantity-input');
            let totalQuantity = 0;
            let totalPrice = 0;
            const categoryTotals = {};

            inputs.forEach(input => {
                const quantity = parseInt(input.value) || 0;
                const supplyPrice = parseFloat(input.dataset.supplyPrice) || 0;
                const category = input.dataset.category;
                
                totalQuantity += quantity;
                totalPrice += quantity * supplyPrice;
                
                if (!categoryTotals[category]) {
                    categoryTotals[category] = { quantity: 0, price: 0 };
                }
                categoryTotals[category].quantity += quantity;
                categoryTotals[category].price += quantity * supplyPrice;
            });
            
            // 전체 합계 업데이트
            const totalQuantityEl = document.getElementById('totalQuantity');
            const totalPriceEl = document.getElementById('totalPrice');
            if (totalQuantityEl) totalQuantityEl.textContent = totalQuantity.toLocaleString();
            if (totalPriceEl) totalPriceEl.textContent = '₩' + Math.round(totalPrice).toLocaleString();
            
            // 카테고리별 소계 업데이트
            Object.keys(categoryTotals).forEach(category => {
                const quantityCell = document.querySelector(`[data-category-total-quantity="${category}"]`);
                const priceCell = document.querySelector(`[data-category-total-price="${category}"]`);
                
                if (quantityCell) {
                    quantityCell.textContent = categoryTotals[category].quantity.toLocaleString();
                }
                if (priceCell) {
                    priceCell.textContent = '₩' + Math.round(categoryTotals[category].price).toLocaleString();
                }
            });
        }

        // 유틸리티 함수들
        function isCurrentYear(date) {
            return date.getFullYear() === new Date().getFullYear();
        }

        function formatDate(date) {
            return date.getFullYear() + '-' + 
                   String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                   String(date.getDate()).padStart(2, '0');
        }

        function showAlert(message, type = 'info') {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 3000);
        }

        // 날짜 선택 (fallback)
        function selectDate() {
            const datePicker = document.getElementById('date-picker');
            const dateValue = datePicker.value;
            location.href = '/subsidiary/input?date=' + dateValue;
        }
    </script>
</body>
</html>