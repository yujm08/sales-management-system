<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <title>월별 매출 집계 - 마이넷 매출 관리 시스템</title>
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <style>
      /* 전체 스타일 */
      .main-container {
        padding: 20px;
        background: #f8f9fa;
        min-height: 100vh;
      }

      .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-bottom: 20px;
      }

      /* 헤더 영역 */
      .page-header {
        padding: 20px;
        background: #e9ecef;
        border-bottom: 1px solid #dee2e6;
      }

      .page-header h2 {
        margin: 0;
        color: #212529;
        font-size: 20px;
      }

      .page-header .year-info {
        margin-top: 5px;
        color: #6c757d;
        font-size: 14px;
      }

      /* 월별 비교 표 */
      .monthly-table-container {
        overflow-x: auto;
        padding: 20px;
      }

      .monthly-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
        background: white;
        border: 1px solid white;
      }

      /* 헤더 스타일 */
      .monthly-table thead tr:first-child th {
        background: #24595e;
        color: white;
        padding: 12px 8px;
        text-align: center;
        font-weight: 600;
        border: 1px solid white;
      }

      .monthly-table thead tr:nth-child(2) th {
        background: #dee2e6;
        color: #333;
        padding: 10px 8px;
        text-align: center;
        font-weight: 600;
        border: 1px solid white;
      }

      /* 구분 상단 헤더 */
      .monthly-table thead tr:first-child th:first-child {
        background: #24595e;
        color: white;
      }

      /* 분류, 제품코드, 제품명 헤더 */
      .monthly-table thead tr:nth-child(2) th:nth-child(-n + 3) {
        background: #d3d3d3;
        color: #000;
      }

      /* 데이터 행 */
      .monthly-table tbody td {
        padding: 8px;
        text-align: center;
        border: 1px solid white;
      }

      /* 구분 열 (분류/제품코드/제품명) */
      .category-col {
        background: #f1f3f5;
        color: #000;
        font-weight: 600;
      }

      .product-code-col {
        background: #f1f3f5;
        color: #000;
      }

      .product-name-col {
        background: #f1f3f5;
        color: #000;
        text-align: left;
        padding-left: 10px;
      }

      /* 카테고리별 배경색 */
      .green-1 {
        background: #e8f5e8;
      }
      .green-2 {
        background: #d4f4d4;
      }
      .green-3 {
        background: #c0f0c0;
      }
      .green-4 {
        background: #b3e6b3;
      }

      /* 합계 열 */
      .total-quantity {
        background: #e3f2fd !important;
        font-weight: 600;
      }

      .total-amount {
        background: #ffe5d9 !important;
        font-weight: 600;
      }

      /* 전체 합계 행 */
      .grand-total-row td {
        background: #dee2e6 !important;
        font-weight: 700;
        color: #000;
      }

      .grand-total-label {
        background: #d3d3d3 !important;
        color: #000;
      }

      /* 숫자 포맷 */
      .amount {
        text-align: right;
        padding-right: 10px;
      }

      .change-password-link {
        color: white;
        text-decoration: none;
        padding: 6px 12px;
        border: 1px solid white;
        border-radius: 4px;
        font-size: 14px;
        transition: background-color 0.2s;
        margin-right: 10px;
        display: inline-block;
      }

      .change-password-link:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }
    </style>
  </head>
  <body>
    <!-- 헤더 -->
    <header class="header">
      <div class="header-content">
        <div class="logo">마이넷 매출 관리 시스템</div>
        <div class="user-info">
          <a th:href="@{/change-password}" class="change-password-link"
            >비밀번호 변경</a
          >
          <span
            class="user-name"
            th:text="${#authentication.principal.username}"
            >사용자</span
          >
          <span
            class="user-company"
            th:text="'(' + ${#authentication.principal.companyName} + ')'"
            >(회사명)</span
          >
          <form th:action="@{/logout}" method="post" style="display: inline">
            <button type="submit" class="logout-btn">로그아웃</button>
          </form>
        </div>
      </div>
    </header>

    <!-- 네비게이션 -->
    <nav class="nav-menu">
      <div class="nav-content">
        <div class="nav-item">
          <a th:href="@{/subsidiary/input}">입력</a>
        </div>
        <div class="nav-item">
          <a th:href="@{/subsidiary/sales-summary}">조회</a>
        </div>
        <div class="nav-item active">
          <a th:href="@{/subsidiary/monthly}">월별매출집계</a>
        </div>
      </div>
    </nav>

    <!-- 메인 컨텐츠 -->
    <main class="main-container">
      <div class="card">
        <!-- 헤더 영역 -->
        <div class="page-header">
          <h3 th:text=" ${currentYear} + '년 데이터'">N년</h3>
        </div>

        <!-- 월별 비교 표 -->
        <div class="monthly-table-container">
          <table class="monthly-table">
            <thead>
              <tr>
                <th colspan="3">구분</th>
                <th colspan="2">1월</th>
                <th colspan="2">2월</th>
                <th colspan="2">3월</th>
                <th colspan="2">4월</th>
                <th colspan="2">5월</th>
                <th colspan="2">6월</th>
                <th colspan="2">7월</th>
                <th colspan="2">8월</th>
                <th colspan="2">9월</th>
                <th colspan="2">10월</th>
                <th colspan="2">11월</th>
                <th colspan="2">12월</th>
                <th colspan="2">합계</th>
              </tr>
              <tr>
                <th>분류</th>
                <th>제품코드</th>
                <th>제품명</th>
                <th>수량</th>
                <th>금액</th>
                <th>수량</th>
                <th>금액</th>
                <th>수량</th>
                <th>금액</th>
                <th>수량</th>
                <th>금액</th>
                <th>수량</th>
                <th>금액</th>
                <th>수량</th>
                <th>금액</th>
                <th>수량</th>
                <th>금액</th>
                <th>수량</th>
                <th>금액</th>
                <th>수량</th>
                <th>금액</th>
                <th>수량</th>
                <th>금액</th>
                <th>수량</th>
                <th>금액</th>
                <th>수량</th>
                <th>금액</th>
                <th>수량</th>
                <th>금액</th>
              </tr>
            </thead>
            <tbody>
              <!-- 데이터가 없는 경우 -->
              <tr th:if="${#lists.isEmpty(monthlyData)}">
                <td
                  colspan="29"
                  style="padding: 40px; text-align: center; color: #6c757d"
                >
                  표시할 데이터가 없습니다.
                </td>
              </tr>

              <!-- 카테고리별 데이터 -->
              <th:block th:each="categoryData, categoryStat : ${monthlyData}">
                <!-- 각 제품 행 -->
                <tr th:each="product, productStat : ${categoryData.products}">
                  <!-- 분류 (카테고리 첫 행에만 표시) -->
                  <td
                    th:if="${productStat.first}"
                    class="category-col"
                    th:rowspan="${#lists.size(categoryData.products)}"
                    th:text="${categoryData.category}"
                  ></td>

                  <!-- 제품코드 -->
                  <td
                    class="product-code-col"
                    th:text="${product.productCode}"
                  ></td>

                  <!-- 제품명 -->
                  <td
                    class="product-name-col"
                    th:text="${product.productName}"
                  ></td>

                  <!-- 1월 ~ 12월 데이터 -->
                  <th:block th:each="month : ${#numbers.sequence(1, 12)}">
                    <td
                      th:class="'green-' + ${categoryColorIndex != null ? categoryColorIndex[categoryData.category] : ((categoryStat.index % 4) + 1)}"
                      th:text="${product.monthlyData[month - 1].quantity == null or product.monthlyData[month - 1].quantity == 0 ? '-' : #numbers.formatInteger(product.monthlyData[month - 1].quantity, 0, 'COMMA')}"
                    ></td>
                    <td
                      th:class="'green-' + ${categoryColorIndex != null ? categoryColorIndex[categoryData.category] : ((categoryStat.index % 4) + 1)} + ' amount'"
                      th:text="${product.monthlyData[month - 1].amount == null or product.monthlyData[month - 1].amount == 0 ? '-' : #numbers.formatInteger(product.monthlyData[month - 1].amount, 0, 'COMMA')}"
                    ></td>
                  </th:block>

                  <!-- 합계 -->
                  <td
                    class="total-quantity"
                    th:text="${product.totalQuantity == null or product.totalQuantity == 0 ? '-' : #numbers.formatInteger(product.totalQuantity, 0, 'COMMA')}"
                  ></td>
                  <td
                    class="total-amount amount"
                    th:text="${product.totalAmount == null or product.totalAmount == 0 ? '-' : #numbers.formatInteger(product.totalAmount, 0, 'COMMA')}"
                  ></td>
                </tr>
              </th:block>

              <!-- 전체 합계 행 -->
              <tr th:if="${grandTotal != null}" class="grand-total-row">
                <td
                  colspan="3"
                  class="grand-total-label"
                  style="text-align: center"
                >
                  <strong>전체 합계</strong>
                </td>

                <!-- 1월 ~ 12월 합계 -->
                <th:block th:each="month : ${#numbers.sequence(1, 12)}">
                  <td>
                    <strong
                      th:text="${grandTotal.monthlyTotals[month - 1].quantity == null or grandTotal.monthlyTotals[month - 1].quantity == 0 ? '-' : #numbers.formatInteger(grandTotal.monthlyTotals[month - 1].quantity, 0, 'COMMA')}"
                    ></strong>
                  </td>
                  <td class="amount">
                    <strong
                      th:text="${grandTotal.monthlyTotals[month - 1].amount == null or grandTotal.monthlyTotals[month - 1].amount == 0 ? '-' : #numbers.formatInteger(grandTotal.monthlyTotals[month - 1].amount, 0, 'COMMA')}"
                    ></strong>
                  </td>
                </th:block>

                <!-- 전체 합계 -->
                <td>
                  <strong
                    th:text="${grandTotal.totalQuantity == null or grandTotal.totalQuantity == 0 ? '-' : #numbers.formatInteger(grandTotal.totalQuantity, 0, 'COMMA')}"
                  ></strong>
                </td>
                <td class="amount">
                  <strong
                    th:text="${grandTotal.totalAmount == null or grandTotal.totalAmount == 0 ? '-' : #numbers.formatInteger(grandTotal.totalAmount, 0, 'COMMA')}"
                  ></strong>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <script th:src="@{/js/common.js}"></script>
  </body>
</html>
