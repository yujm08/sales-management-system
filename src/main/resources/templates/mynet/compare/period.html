<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <title>기간별 비교 - 마이넷 매출 관리 시스템</title>
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <!-- flatpickr (기간 선택 달력용) -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>

    <style>
      .main-container {
        padding: 20px;
        background: #f8f9fa;
        min-height: 100vh;
      }

      .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      /* 추천 검색어 하이라이트 스타일 */
      .highlight {
        background-color: #fff3cd;
        color: #d63384;
        font-weight: 600;
        border-radius: 2px;
        padding: 0 2px;
      }

      /* 달력에서 선택된 구간(시작~종료) 표시 색상 */
      .flatpickr-day.inRange {
        background: #d9eaff !important;
        box-shadow: inset 0 0 0 1000px #d6e9ff !important;
        border: none !important;
        color: #000 !important;
      }

      .flatpickr-day.startRange,
      .flatpickr-day.endRange {
        background: #007bff !important;
        color: white !important;
        border-radius: 50% !important;
        position: relative;
        z-index: 2;
      }

      /* 경계가 부드럽게 이어지도록 그림자 제거 */
      .flatpickr-day {
        box-shadow: none !important;
      }

      /* hover 시도 자연스럽게 */
      .flatpickr-day:hover {
        background: #c7e0ff !important;
      }

      /* 제품 목록 토글 버튼 */
      .toggle-section {
        padding: 15px 20px;
        border-bottom: 1px solid #dee2e6;
      }

      .toggle-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .toggle-btn:hover {
        background: #0056b3;
      }

      .toggle-icon {
        font-weight: bold;
        font-size: 16px;
      }

      /* 제품 목록 테이블 */
      .product-list {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
      }

      .product-list.expanded {
        max-height: 500px;
        overflow-y: auto;
      }

      .product-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      .product-table thead th {
        background: #24595e;
        color: white;
        padding: 12px 8px;
        text-align: center;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .product-table tbody tr:nth-child(odd) {
        background: #f8f9fa;
      }

      .product-table tbody tr:nth-child(even) {
        background: white;
      }

      .product-table tbody tr:hover {
        background: #e9ecef;
        cursor: pointer;
      }

      .product-table tbody td {
        padding: 10px 8px;
        text-align: center;
        border-bottom: 1px solid #dee2e6;
      }

      .product-inactive {
        color: #6c757d;
        text-decoration: line-through;
      }

      /* 검색 및 기간 선택 */
      .search-section {
        padding: 20px;
        background: #e9ecef;
        border-bottom: 1px solid #dee2e6;
      }

      .search-row {
        display: flex;
        gap: 15px;
        align-items: flex-end;
        flex-wrap: wrap;
      }

      .search-group {
        flex: 1;
        min-width: 200px;
        position: relative;
      }

      .search-group label {
        display: block;
        font-weight: 600;
        font-size: 14px;
        color: #495057;
        margin-bottom: 5px;
      }

      .search-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
      }

      /* 자동완성 드롭다운 */
      .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ced4da;
        border-top: none;
        border-radius: 0 0 4px 4px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .autocomplete-item {
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f1f3f5;
      }

      .autocomplete-item:hover {
        background: #e9ecef;
      }

      .autocomplete-item:last-child {
        border-bottom: none;
      }

      /* 기간 선택 박스 */
      .period-boxes {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        margin-top: 15px;
      }

      .period-box {
        background: white;
        border: 1px solid #ced4da;
        border-radius: 4px;
        padding: 15px;
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .period-input-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .period-input-group label {
        font-size: 12px;
        color: #6c757d;
      }

      .period-input-group input {
        padding: 6px 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 13px;
      }

      .btn-add-period {
        background: #28a745;
        color: white;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 20px;
        cursor: pointer;
        flex-shrink: 0;
      }

      .btn-add-period:hover {
        background: #218838;
      }

      .btn-remove-period {
        background: #dc3545;
        color: white;
        border: none;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        font-size: 16px;
        cursor: pointer;
        flex-shrink: 0;
      }

      .btn-remove-period:hover {
        background: #c82333;
      }

      .btn-search {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 30px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-top: 15px;
      }

      .btn-search:hover {
        background: #0056b3;
      }

      /* 결과 표시 영역 */
      .results-section {
        padding: 20px;
      }

      .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }

      .period-result-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
      }

      .period-result-header {
        background: #24595e;
        color: white;
        padding: 15px;
        font-weight: 600;
        text-align: center;
      }

      .period-summary {
        background: #e9ecef;
        padding: 15px;
        display: flex;
        justify-content: space-around;
        border-bottom: 2px solid #dee2e6;
      }

      .summary-item {
        text-align: center;
      }

      .summary-label {
        font-size: 12px;
        color: #6c757d;
        margin-bottom: 5px;
      }

      .summary-value {
        font-size: 18px;
        font-weight: 700;
        color: #495057;
      }

      .btn-toggle-details {
        width: 100%;
        background: #f8f9fa;
        border: none;
        border-top: 1px solid #dee2e6;
        border-bottom: 1px solid #dee2e6;
        padding: 10px;
        cursor: pointer;
        font-size: 13px;
        color: #007bff;
        font-weight: 600;
      }

      .btn-toggle-details:hover {
        background: #e9ecef;
      }

      .period-details {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
      }

      .period-details.expanded {
        max-height: 400px;
        overflow-y: auto;
      }

      .details-table {
        width: 100%;
        font-size: 12px;
      }

      .details-table thead th {
        background: #f8f9fa;
        padding: 8px;
        text-align: center;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
        position: sticky;
        top: 0;
      }

      .details-table tbody td {
        padding: 8px;
        text-align: center;
        border-bottom: 1px solid #f1f3f5;
      }

      .details-table tbody tr:hover {
        background: #f8f9fa;
      }

      .amount-cell {
        text-align: right;
        padding-right: 15px;
      }

      .no-results {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
        font-size: 15px;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .error {
        text-align: center;
        padding: 40px;
        color: #d32f2f;
      }

      /* 네비게이션 서브메뉴 */
      .nav-item {
        position: relative;
      }

      .sub-menu {
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        min-width: 150px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        border-radius: 4px;
        z-index: 1000;
        display: none;
      }

      .nav-item:hover .sub-menu {
        display: block;
      }

      .sub-menu a {
        display: block;
        padding: 10px 15px;
        color: #333;
        text-decoration: none;
        border-bottom: 1px solid #eee;
      }

      .sub-menu a:last-child {
        border-bottom: none;
        border-radius: 0 0 4px 4px;
      }

      .sub-menu a:hover {
        background: #f8f9fa;
      }

      .sub-menu a.active {
        background: #e9ecef;
        font-weight: 600;
      }

      /* 반응형 */
      @media (max-width: 768px) {
        .results-grid {
          grid-template-columns: 1fr;
        }

        .search-row {
          flex-direction: column;
        }

        .period-boxes {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <!-- 헤더 -->
    <header class="header">
      <div class="header-content">
        <div class="logo">마이넷 매출 관리 시스템</div>
        <div class="user-info">
          <span
            class="user-name"
            th:text="${#authentication.principal.companyName}"
            >마이넷</span
          >
          <span class="user-role">(마이넷)</span>
          <form th:action="@{/logout}" method="post" style="display: inline">
            <button type="submit" class="logout-btn">로그아웃</button>
          </form>
        </div>
      </div>
    </header>

    <!-- 네비게이션 -->
    <nav class="nav-menu">
      <div class="nav-content">
        <div class="nav-item">
          <a
            th:href="@{${#authentication.principal.canon ? '/canon/view' : '/mynet/view'}}"
            >조회</a
          >
        </div>
        <div class="nav-item active">
          <a href="javascript:void(0)">비교 ▼</a>
          <div class="sub-menu">
            <a th:href="@{/mynet/compare/monthly}">월별</a>
            <a th:href="@{/mynet/compare/yearly}">년도별</a>
            <a th:href="@{/mynet/compare/period}" class="active">기간별</a>
            <a th:href="@{/mynet/compare/product}">제품별</a>
          </div>
        </div>
        <div class="nav-item">
          <a th:href="@{/admin/products}">제품 분류</a>
        </div>
        <div class="nav-item" th:if="${!isCanon}">
          <a th:href="@{/admin/users}">사용자 관리</a>
        </div>
      </div>
    </nav>

    <!-- 메인 컨텐츠 -->
    <main class="main-container">
      <h2 style="margin-bottom: 20px">기간별 비교</h2>

      <div class="card">
        <!-- 제품 목록 토글 -->
        <div class="toggle-section">
          <button class="toggle-btn" onclick="toggleProductList()">
            <span id="toggleText">제품 목록 보기</span>
            <span class="toggle-icon" id="toggleIcon">+</span>
          </button>
        </div>

        <!-- 제품 목록 테이블 -->
        <div class="product-list" id="productList">
          <table class="product-table">
            <thead>
              <tr>
                <th>분류</th>
                <th>제품코드</th>
                <th>제품명</th>
                <th>원가</th>
                <th>판매가</th>
              </tr>
            </thead>
            <tbody id="productTableBody">
              <tr>
                <td
                  colspan="5"
                  style="padding: 40px; text-align: center; color: #6c757d"
                >
                  로딩 중...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- 검색 및 기간 선택 -->
        <div class="search-section">
          <div class="search-row">
            <div class="search-group">
              <label>제품명 또는 제품코드</label>
              <input
                type="text"
                class="search-input"
                id="productSearch"
                placeholder="제품을 검색하세요 (선택 시 해당 제품만 조회)"
                oninput="handleProductSearch()"
              />
              <div
                class="autocomplete-dropdown"
                id="autocompleteDropdown"
              ></div>
            </div>
          </div>

          <!-- 기간 선택 박스들 -->
          <div class="period-boxes" id="periodBoxes">
            <div class="period-box" data-period-index="0">
              <div class="period-input-group" style="flex-direction: column">
                <label>기간 선택</label>
                <input
                  type="text"
                  class="period-range"
                  placeholder="날짜 범위를 선택하세요"
                  readonly
                />
              </div>
            </div>
            <button class="btn-add-period" onclick="addPeriod()">+</button>
          </div>

          <button class="btn-search" onclick="searchPeriodData()">조회</button>
        </div>
      </div>

      <!-- 결과 표시 -->
      <div class="results-section">
        <div id="loadingMessage" class="loading" style="display: none">
          데이터를 불러오는 중...
        </div>
        <div id="errorMessage" class="error" style="display: none">
          데이터를 불러오는데 실패했습니다.
        </div>
        <div id="noResults" class="no-results">
          기간을 선택하고 조회 버튼을 클릭하세요.
        </div>
        <div class="results-grid" id="resultsGrid"></div>
      </div>
    </main>

    <script th:src="@{/js/common.js}"></script>
    <script>
      let allProducts = [];
      let selectedProductId = null;

      // CSRF 토큰 가져오기
      const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
      const csrfHeader = document.querySelector(
        'meta[name="_csrf_header"]'
      )?.content;

      // 페이지 로드 시 제품 목록 불러오기
      window.addEventListener("DOMContentLoaded", () => {
        loadProducts();

        // 초기 첫 번째 기간 입력칸에도 flatpickr 적용
        const firstRange = document.querySelector(".period-range");
        if (firstRange) {
          flatpickr(firstRange, {
            mode: "range",
            dateFormat: "Y-m-d",
            locale: "ko",
            rangeSeparator: " ~ ",
            onChange: function (selectedDates, dateStr) {
              firstRange.closest(".period-box").dataset.range = dateStr;
            },
          });
        }
      });

      async function loadProducts() {
        try {
          const response = await fetch("/api/statistics/products");
          if (!response.ok) throw new Error("제품 목록 조회 실패");

          allProducts = await response.json();
          renderProductTable();
        } catch (error) {
          console.error("제품 목록 로드 오류:", error);
          document.getElementById("productTableBody").innerHTML =
            '<tr><td colspan="5" style="padding: 40px; color: #d32f2f;">제품 목록을 불러올 수 없습니다.</td></tr>';
        }
      }

      function renderProductTable() {
        const tbody = document.getElementById("productTableBody");
        tbody.innerHTML = "";

        // ① 카테고리별 그룹화 후 코드순 정렬
        const grouped = allProducts.reduce((acc, p) => {
          if (!acc[p.category]) acc[p.category] = [];
          acc[p.category].push(p);
          return acc;
        }, {});
        Object.keys(grouped).forEach((cat) => {
          grouped[cat].sort((a, b) =>
            a.productCode.localeCompare(b.productCode)
          );
        });

        // ② 색상 팔레트 정의
        const colors = ["#E8F5E8", "#D4F4D4", "#C0F0C0", "#B3E6B3"];
        let colorIndex = 0;

        // ③ 카테고리별 렌더링
        Object.entries(grouped).forEach(([category, products]) => {
          const bgColor = colors[colorIndex % colors.length];
          colorIndex++;

          products.forEach((product, i) => {
            const row = document.createElement("tr");
            const inactiveClass = !product.active ? "product-inactive" : "";

            row.style.backgroundColor = bgColor;

            // 첫 행에만 분류명 표시 (rowspan)
            if (i === 0) {
              const catCell = document.createElement("td");
              catCell.textContent = category;
              catCell.rowSpan = products.length;
              catCell.style.background = "#d9d9d9";
              catCell.style.fontWeight = "600";
              catCell.style.writingMode = "center";
              catCell.style.textAlign = "center";
              catCell.style.color = "#333";
              row.appendChild(catCell);
            }

            row.innerHTML += `
  <td class="${inactiveClass}" style="text-align:center; border-right:1px solid #ccc;">${
              product.productCode
            }</td>
  <td class="${inactiveClass}" style="text-align:center; border-right:1px solid #ccc;">${
              product.productName
            }</td>
  <td class="${inactiveClass}" style="text-align:right; border-right:1px solid #ccc;">₩${formatNumber(
              product.currentCostPrice
            )}</td>
  <td class="${inactiveClass}" style="text-align:right;">₩${formatNumber(
              product.currentSupplyPrice
            )}</td>
`;

            row.onclick = () => selectProduct(product);
            tbody.appendChild(row);
          });
        });
      }

      function toggleProductList() {
        const list = document.getElementById("productList");
        const icon = document.getElementById("toggleIcon");
        const text = document.getElementById("toggleText");

        list.classList.toggle("expanded");

        if (list.classList.contains("expanded")) {
          icon.textContent = "-";
          text.textContent = "제품 목록 닫기";
        } else {
          icon.textContent = "+";
          text.textContent = "제품 목록 보기";
        }
      }

      function selectProduct(product) {
        selectedProductId = product.id;
        document.getElementById(
          "productSearch"
        ).value = `${product.productCode} - ${product.productName}`;
        hideAutocomplete();

        // 제품 목록 닫기
        const list = document.getElementById("productList");
        if (list.classList.contains("expanded")) {
          toggleProductList();
        }
      }

      function handleProductSearch() {
        const searchValue = document
          .getElementById("productSearch")
          .value.trim()
          .toLowerCase();

        if (searchValue === "") {
          selectedProductId = null;
          hideAutocomplete();
          return;
        }

        const filtered = allProducts.filter(
          (p) =>
            p.productName.toLowerCase().includes(searchValue) ||
            p.productCode.toLowerCase().includes(searchValue)
        );

        showAutocomplete(filtered);
      }

      function showAutocomplete(products) {
        const dropdown = document.getElementById("autocompleteDropdown");
        dropdown.innerHTML = "";

        if (products.length === 0) {
          dropdown.style.display = "none";
          return;
        }

        const query = document
          .getElementById("productSearch")
          .value.trim()
          .toLowerCase();

        products.slice(0, 10).forEach((product) => {
          const item = document.createElement("div");
          item.className = "autocomplete-item";

          const highlightText = (text) => {
            const regex = new RegExp(`(${query})`, "gi");
            return text.replace(regex, `<span class="highlight">$1</span>`);
          };

          const code = highlightText(product.productCode);
          const name = highlightText(product.productName);

          item.innerHTML = `${code} - ${name}`;
          item.onclick = () => selectProduct(product);
          dropdown.appendChild(item);
        });

        dropdown.style.display = "block";
      }

      function hideAutocomplete() {
        document.getElementById("autocompleteDropdown").style.display = "none";
      }

      // 외부 클릭 시 자동완성 닫기
      document.addEventListener("click", (e) => {
        if (!e.target.closest(".search-group")) {
          hideAutocomplete();
        }
      });

      function addPeriod() {
        const periodBoxes = document.getElementById("periodBoxes");
        const currentCount = periodBoxes.querySelectorAll(".period-box").length;

        if (currentCount >= 4) {
          alert("최대 4개의 기간만 선택할 수 있습니다.");
          return;
        }

        const newBox = document.createElement("div");
        newBox.className = "period-box";
        newBox.dataset.periodIndex = currentCount;
        newBox.innerHTML = `
      <div class="period-input-group" style="flex-direction: column;">
          <label>기간 선택</label>
          <input type="text" class="period-range" placeholder="날짜 범위를 선택하세요" readonly />
      </div>
      <button class="btn-remove-period" onclick="removePeriod(this)">×</button>
  `;

        periodBoxes.insertBefore(newBox, periodBoxes.lastElementChild);

        // flatpickr 달력 활성화
        flatpickr(newBox.querySelector(".period-range"), {
          mode: "range",
          dateFormat: "Y-m-d",
          locale: "ko",
          rangeSeparator: " ~ ",
          onChange: function (selectedDates, dateStr) {
            newBox.dataset.range = dateStr; // 나중에 조회 시 사용
          },
        });
      }

      function removePeriod(button) {
        button.closest(".period-box").remove();
      }

      async function searchPeriodData() {
        const periodBoxes = document.querySelectorAll(".period-box");
        const periods = [];

        // 기간 데이터 수집 및 검증
        for (let box of periodBoxes) {
          const range = box.dataset.range;
          if (!range) {
            alert("모든 기간의 날짜를 선택해주세요.");
            return;
          }
          const [startDate, endDate] = range.split(" ~ ");

          if (!startDate || !endDate) {
            alert("모든 기간의 시작일과 종료일을 입력해주세요.");
            return;
          }

          const start = new Date(startDate);
          const end = new Date(endDate);

          if (start > end) {
            alert("시작일은 종료일보다 이전이어야 합니다.");
            return;
          }

          const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
          if (daysDiff > 30) {
            alert("한 기간은 최대 30일까지만 선택할 수 있습니다.");
            return;
          }

          periods.push({ startDate, endDate });
        }

        if (periods.length === 0) {
          alert("최소 1개의 기간을 선택해주세요.");
          return;
        }

        // API 호출
        showLoading();

        try {
          const response = await fetch("/api/statistics/period-comparison", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              [csrfHeader]: csrfToken,
            },
            body: JSON.stringify({
              productId: selectedProductId,
              periods: periods,
            }),
          });

          if (!response.ok) throw new Error("데이터 조회 실패");

          const data = await response.json();
          renderResults(data);
        } catch (error) {
          console.error("기간 데이터 조회 오류:", error);
          showError();
        }
      }

      function showLoading() {
        document.getElementById("loadingMessage").style.display = "block";
        document.getElementById("errorMessage").style.display = "none";
        document.getElementById("noResults").style.display = "none";
        document.getElementById("resultsGrid").innerHTML = "";
      }

      function showError() {
        document.getElementById("loadingMessage").style.display = "none";
        document.getElementById("errorMessage").style.display = "block";
        document.getElementById("noResults").style.display = "none";
        document.getElementById("resultsGrid").innerHTML = "";
      }

      function renderResults(periodsData) {
        document.getElementById("loadingMessage").style.display = "none";
        document.getElementById("errorMessage").style.display = "none";
        document.getElementById("noResults").style.display = "none";

        const grid = document.getElementById("resultsGrid");
        grid.innerHTML = "";

        periodsData.forEach((periodData, index) => {
          const card = createPeriodCard(periodData, index);
          grid.appendChild(card);
        });
      }

      function createPeriodCard(periodData, index) {
        const card = document.createElement("div");
        card.className = "period-result-card";

        const startDate = formatDate(periodData.startDate);
        const endDate = formatDate(periodData.endDate);

        card.innerHTML = `
                <div class="period-result-header">
                    ${startDate} ~ ${endDate}
                </div>
                <div class="period-summary">
                    <div class="summary-item">
                        <div class="summary-label">총 수량</div>
                        <div class="summary-value">${formatDisplay(
                          periodData.totalQuantity
                        )}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">총 금액</div>
                        <div class="summary-value">${formatDisplayCurrency(
                          periodData.totalAmount
                        )}</div>
                    </div>
                </div>
                <button class="btn-toggle-details" onclick="toggleDetails(${index})">
                    <span id="detailsToggleText${index}">상세 보기 ▼</span>
                </button>
                <div class="period-details" id="periodDetails${index}">
                    <table class="details-table">
                        <thead>
                            <tr>
                                <th>날짜</th>
                                <th>수량</th>
                                <th>금액</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${renderDailyDetails(periodData.dailyDetails)}
                        </tbody>
                    </table>
                </div>
            `;

        return card;
      }

      function renderDailyDetails(dailyDetails) {
        return dailyDetails
          .map(
            (day) => `
                <tr>
                    <td>${formatDate(day.date)}</td>
                    <td>${formatDisplay(day.quantity)}</td>
                    <td class="amount-cell">${formatDisplayCurrency(
                      day.amount
                    )}</td>
                </tr>
            `
          )
          .join("");
      }

      function toggleDetails(index) {
        const details = document.getElementById(`periodDetails${index}`);
        const toggleText = document.getElementById(`detailsToggleText${index}`);

        details.classList.toggle("expanded");

        if (details.classList.contains("expanded")) {
          toggleText.textContent = "상세 닫기 ▲";
        } else {
          toggleText.textContent = "상세 보기 ▼";
        }
      }

      function formatNumber(value) {
        if (value === null || value === undefined) return "0";
        return Math.round(value).toLocaleString("ko-KR");
      }

      function formatDate(dateStr) {
        const date = new Date(dateStr);
        const month = date.getMonth() + 1;
        const day = date.getDate();
        return `${month}/${day}`;
      }

      function formatDisplay(value) {
        if (value === null || value === undefined || value === 0) return "-";
        return formatNumber(value);
      }

      function formatDisplayCurrency(value) {
        if (value === null || value === undefined || value === 0) return "-";
        return "₩" + formatNumber(value);
      }
    </script>
  </body>
</html>
