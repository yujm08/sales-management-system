<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <title>조회 - 마이넷 매출 관리 시스템</title>
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <link rel="stylesheet" th:href="@{/css/datepicker.css}" />
    <script th:src="@{/js/datepicker.js}" defer></script>
    <style>
      /* 전체 스타일 */
      .main-container {
        padding: 20px;
        background: #f8f9fa;
        min-height: 100vh;
      }

      .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .nav-item {
        position: relative;
      }

      .sub-menu {
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        min-width: 150px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        border-radius: 4px;
        z-index: 1000;
        display: none;
      }

      .nav-item:hover .sub-menu {
        display: block;
      }

      .sub-menu a {
        display: block;
        padding: 10px 15px;
        color: #333;
        text-decoration: none;
        border-bottom: 1px solid #eee;
      }

      .sub-menu a:last-child {
        border-bottom: none;
        border-radius: 0 0 4px 4px;
      }

      .sub-menu a:hover {
        background: #f8f9fa;
      }

      /* 상단 버튼 영역 */
      .control-panel {
        background: #e9ecef;
        padding: 15px 20px;
        border-bottom: 1px solid #dee2e6;
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        position: relative;
      }

      .download-btn {
        background: #7a7a7a;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background-color 0.2s;
        white-space: nowrap;
      }

      .download-btn:hover {
        background: #666666;
      }

      .download-btn:active {
        background: #4f4f4f;
      }

      /* 좌측 */
      .control-left {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      /* 가운데 – 정확히 중앙 */
      .control-center {
        justify-self: center;
      }

      /* 우측 */
      .control-right {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 10px;
      }

      .left-controls {
        display: flex;
        gap: 10px;
      }

      .btn {
        padding: 8px 16px;
        border: 1px solid #6c757d;
        background: white;
        color: #495057;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      .btn:hover {
        background: #f8f9fa;
      }

      .btn.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
      }

      .company-select {
        padding: 8px 12px;
        border: 1px solid #6c757d;
        border-radius: 4px;
        background: white;
        font-size: 14px;
        min-width: 200px;
      }

      /* 기준 날짜 영역 */
      .date-control-inline {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-left: 20px;
        color: #495057; /* 무채색 */
        font-weight: 500;
        font-size: 14px;
      }

      .date-control-inline .label {
        margin-right: 4px;
        color: #6c757d;
      }

      .date-control-inline .date-nav-btn {
        background: transparent;
        border: 1px solid #adb5bd;
        color: #495057;
        padding: 3px 8px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 13px;
      }

      .date-control-inline .date-nav-btn:hover {
        background: #f1f3f5;
      }

      .date-control-inline .current-date {
        font-weight: 600;
        color: #212529;
        padding: 3px 6px;
        border: 1px solid transparent;
        border-radius: 3px;
        cursor: pointer;
      }

      .date-control-inline .current-date:hover {
        border-color: #ced4da;
        background: #f8f9fa;
      }

      .date-nav-btn {
        background: transparent;
        border: 1px solid white;
        color: white;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 16px;
      }

      .date-nav-btn:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .current-date {
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        padding: 5px 10px;
        border: 1px solid transparent;
        border-radius: 3px;
        color: white;
      }

      .current-date:hover {
        border-color: white;
      }

      .date-picker {
        position: absolute;
        left: -9999px;
        opacity: 0;
      }

      /* 테이블 스타일 */
      .stats-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
        background: white;
      }

      .stats-table th {
        background: #24595e;
        color: white;
        padding: 12px 8px;
        text-align: center;
        font-weight: 600;
        border: 1px solid #ffffff;
        font-size: 12px;
      }

      .stats-table td {
        vertical-align: middle;
        padding: 8px;
        text-align: center;
        border: 1px solid #ffffff;
        font-size: 12px;
      }

      /* 수정 가능한 셀 */
      .editable-cell {
        background-color: #fff3cd !important;
        cursor: pointer;
      }

      .editable-cell:hover {
        background-color: #ffeaa7 !important;
      }

      /* 카테고리 셀 스타일 */
      .category-cell {
        background: #dee2e6;
        color: #333;
        font-weight: bold;
        vertical-align: middle;
        text-align: center;
      }

      /* 카테고리별 배경색 (product-management.html과 동일) */
      .data-cell.green-1 {
        background: #e8f5e8;
      }

      .data-cell.green-2 {
        background: #d4f4d4;
      }

      .data-cell.green-3 {
        background: #c0f0c0;
      }

      .data-cell.green-4 {
        background: #b3e6b3;
      }

      /* 소계/합계 행 */
      .subtotal-row td {
        background-color: #f1f3f5 !important;
        font-weight: 600;
      }

      .total-row td {
        background-color: #d3d3d3 !important;
        font-weight: 700;
        font-size: 13px;
      }

      /* 제품 정보 */
      .product-info {
        text-align: left;
        padding-left: 10px;
      }

      .product-name {
        font-weight: 600;
        font-size: 12px;
      }

      /* 수치 표시 */
      .amount {
        font-weight: 600;
        color: #000000;
        text-align: right;
        padding-right: 10px;
      }

      .profit {
        font-weight: 600;
        color: #dc3545;
        text-align: right;
        padding-right: 10px;
      }

      .profit-detail {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
      }

      .profit-amount {
        font-weight: 600;
        color: #dc3545;
      }

      .profit-change {
        font-size: 10px;
        margin-top: 2px;
        display: flex;
        align-items: center;
        gap: 2px;
      }

      .profit-up {
        color: #dc3545;
      }

      .profit-down {
        color: #007bff;
      }

      /* 달성률 */
      .achievement-rate {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
      }

      .rate-text {
        font-weight: 600;
        color: #495057;
        font-size: 12px;
      }

      .rate-bar {
        width: 60px;
        height: 6px;
        background: #ffffff;
        border-radius: 3px;
        overflow: hidden;
      }

      .rate-fill {
        height: 100%;
        background: #28a745;
        transition: width 0.3s ease;
      }

      .editing-cell input {
        width: 80px;
        text-align: center;
        border: 2px solid #2c5aa0;
        border-radius: 4px;
        padding: 4px;
      }

      /* 툴팁 */
      .tooltip {
        position: relative;
        cursor: pointer;
      }

      .tooltip:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #495057;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        white-space: nowrap;
        z-index: 1000;
      }

      /* 로딩 */
      .loading {
        display: none;
        text-align: center;
        padding: 40px;
        color: #6c757d;
      }

      .spinner {
        border: 3px solid #f3f4f6;
        border-top: 3px solid #2c5aa0;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* 알림 */
      .alert {
        padding: 12px 16px;
        margin-bottom: 16px;
        border-radius: 4px;
        font-weight: 500;
      }

      .alert-success {
        background-color: #d1edff;
        color: #0c5460;
        border: 1px solid #28a745;
      }

      .alert-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #dc3545;
      }

      .change-password-link {
        color: white;
        text-decoration: none;
        padding: 6px 12px;
        border: 1px solid white;
        border-radius: 4px;
        font-size: 14px;
        transition: background-color 0.2s;
        margin-right: 10px;
        display: inline-block;
      }

      .change-password-link:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }

      /* input을 span처럼 보이게 */
      .quantity-input {
        width: 60px;
        text-align: center;
        border: none;
        background: transparent;
        font-size: 12px;
        font-family: inherit;
        color: inherit;
        padding: 0;
        margin: 0;
        outline: none;

        padding-right: 0;
        padding-left: 14px;

        /* 브라우저 기본 스타일 제거*/
        -webkit-appearance: none;
        -moz-appearance: textfield;
        appearance: none;
      }

      /* 수정 모드일 때 */
      .quantity-input.editable {
        border: 1px solid #007bff;
        background: white;
        padding: 2px 4px;
        border-radius: 3px;
      }

      /* 포커스 시 */
      .quantity-input:focus {
        outline: 2px solid #007bff;
        outline-offset: 1px;
      }

      /* readonly일 때 커서 */
      .quantity-input[readonly] {
        cursor: default;
      }

      .quantity-input:not([readonly]) {
        cursor: text;
      }
    </style>
  </head>
  <body>
    <!-- 헤더 -->
    <header class="header">
      <div class="header-content">
        <div class="logo">마이넷 매출 관리 시스템</div>
        <div class="user-info">
          <a th:href="@{/change-password}" class="change-password-link"
            >비밀번호 변경</a
          >
          <span
            class="user-name"
            th:text="${#authentication.principal.username}"
            >마이넷</span
          >
          <span
            class="user-company"
            th:text="'(' + ${#authentication.principal.companyName} + ')'"
            >(마이넷)</span
          >
          <form th:action="@{/logout}" method="post" style="display: inline">
            <button type="submit" class="logout-btn">로그아웃</button>
          </form>
        </div>
      </div>
    </header>

    <!-- 네비게이션 -->
    <nav class="nav-menu">
      <div class="nav-content">
        <div
          class="nav-item"
          th:classappend="${currentPage == 'daily-sales'} ? 'active'"
        >
          <a th:href="@{/mynet/daily-sales}">일일매출현황</a>
        </div>
        <div class="nav-item active">
          <a th:href="@{/mynet/view}">조회</a>
        </div>
        <div class="nav-item">
          <a href="javascript:void(0)">비교 ▼</a>
          <div class="sub-menu">
            <a th:href="@{/mynet/compare/monthly}">월별</a>
            <a th:href="@{/mynet/compare/yearly}">년도별</a>
            <a th:href="@{/mynet/compare/period}">기간별</a>
            <a th:href="@{/mynet/compare/product}">제품별</a>
          </div>
        </div>
        <div class="nav-item">
          <a th:href="@{/admin/products}">제품 분류</a>
        </div>
        <div class="nav-item" th:if="${!isCanon}">
          <a th:href="@{/admin/users}">사용자 관리</a>
        </div>
      </div>
    </nav>

    <!-- 메인 컨텐츠 -->
    <main class="main-container">
      <div id="alert-container"></div>

      <div class="card">
        <!-- 상단 버튼 영역 -->
        <div class="control-panel">
          <div class="control-left">
            <div class="left-controls" th:if="${!isCanon}">
              <button
                class="btn"
                id="total-stats-btn"
                onclick="selectTotalStats()"
              >
                전체 통계
              </button>
              <button
                class="btn"
                id="edit-btn"
                onclick="toggleEdit()"
                style="display: none"
              >
                수정
              </button>
            </div>
            <div class="left-controls" th:if="${isCanon}">
              <button class="btn active" disabled>전체 통계</button>
            </div>
          </div>

          <!-- 기준 날짜 영역 -->
          <div class="control-center">
            <div class="date-control-inline">
              <span>기준 날짜 : </span>
              <button class="date-nav-btn" onclick="changeDate(-1)">◀</button>
              <span
                class="current-date"
                id="current-date"
                onclick="showDatePicker()"
                th:text="${#temporals.format(targetDate, 'yyyy-MM-dd')}"
                >2025-09-07</span
              >
              <button class="date-nav-btn" onclick="changeDate(1)">▶</button>
              <input
                type="date"
                class="date-picker"
                id="date-picker"
                th:value="${targetDate}"
                onchange="selectDate()"
              />
            </div>
          </div>

          <div class="control-right">
            <select
              id="company-select"
              class="company-select"
              onchange="changeCompany(this.value)"
            >
              <option value="">전체 (하위 회사명 선택)</option>
              <option
                th:each="company : ${subsidiaryCompanies}"
                th:value="${company.id}"
                th:text="${company.name}"
                th:selected="${companyFilter == company.id.toString()}"
              >
                회사명
              </option>
            </select>

            <div class="download-btn-wrapper">
              <button class="download-btn" onclick="downloadExcel()">
                엑셀 다운로드
              </button>
            </div>
          </div>
        </div>

        <!-- 로딩 표시 -->
        <div id="loading" class="loading">
          <div class="spinner"></div>
          <p>데이터를 불러오는 중...</p>
        </div>

        <!-- 통계 테이블 -->
        <div class="table-container" id="table-container">
          <table class="stats-table">
            <thead>
              <tr>
                <th colspan="5">제품</th>
                <th colspan="3">일 합계</th>
                <th colspan="3">월 합계</th>
                <th colspan="2">목표수량</th>
              </tr>
              <tr>
                <th>분류</th>
                <th>제품코드</th>
                <th>제품명</th>
                <th>원가</th>
                <th>공급가</th>
                <th>수량</th>
                <th>금액</th>
                <th>이익</th>
                <th>수량</th>
                <th>금액</th>
                <th>이익</th>
                <th th:text="${currentMonth + '월'}">9월</th>
                <th>달성률</th>
              </tr>
            </thead>
            <!-- 수정된 tbody 부분 -->
            <tbody id="stats-tbody">
              <!-- 데이터가 없는 경우 -->
              <tr th:if="${#lists.isEmpty(statisticsData)}">
                <td
                  colspan="13"
                  style="text-align: center; padding: 40px; color: #6c757d"
                >
                  표시할 데이터가 없습니다.
                </td>
              </tr>

              <!-- 통계 데이터 반복 -->
              <th:block
                th:each="categoryEntry, categoryStat : ${statisticsData}"
              >
                <!-- 제품 데이터만 먼저 표시 -->
                <th:block
                  th:each="item, itemStat : ${categoryEntry.value}"
                  th:if="${item != null and item.productCode != null}"
                >
                  <tr>
                    <!-- 카테고리 셀 (첫 번째 제품에만 표시) -->
                    <td
                      th:if="${itemStat.first}"
                      class="category-cell"
                      th:rowspan="${#lists.size(categoryEntry.value)}"
                      th:text="${categoryEntry.key}"
                    >
                      카테고리
                    </td>

                    <!-- 제품 정보 -->
                    <td
                      th:class="'data-cell green-' + ${(categoryStat.index % 4) + 1}"
                      th:text="${item.productCode}"
                    >
                      제품코드
                    </td>
                    <td
                      th:class="'data-cell green-' + ${(categoryStat.index % 4) + 1}"
                      class="product-info"
                    >
                      <div class="product-name" th:text="${item.productName}">
                        제품명
                      </div>
                    </td>
                    <td
                      th:class="'data-cell green-' + ${(categoryStat.index % 4) + 1} + ' amount'"
                      th:text="${#numbers.formatInteger(item.costPrice, 0, 'COMMA')}"
                    >
                      원가
                    </td>
                    <td
                      th:class="'data-cell green-' + ${(categoryStat.index % 4) + 1} + ' amount'"
                      th:text="${#numbers.formatInteger(item.supplyPrice, 0, 'COMMA')}"
                    >
                      공급가
                    </td>

                    <!-- 일별 수량 (수정 가능) -->
                    <td
                      class="data-cell green-1 tooltip"
                      th:classappend="${companyFilter != '' and !isCanon} ? ' editable-cell' : ''"
                      th:data-tooltip="${item.dailySummary?.lastModifiedAt != null ?
                        ('수정: ' + #temporals.format(item.dailySummary.lastModifiedAt, 'yyyy-MM-dd HH:mm') +
                        ' by ' + item.dailySummary.modifiedBy) : '수정 기록 없음'}"
                    >
                      <input
                        type="number"
                        class="quantity-input"
                        th:value="${item.dailySummary?.quantity ?: 0}"
                        th:data-product-id="${item.productId}"
                        th:data-company-id="${companyFilter}"
                        th:data-type="'quantity'"
                        readonly
                        min="-999999"
                      />
                    </td>

                    <!-- 일별 금액 -->
                    <td
                      th:class="'data-cell green-' + ${(categoryStat.index % 4) + 1} + ' amount'"
                      th:text="${#numbers.formatInteger(item.dailySummary?.amount ?: 0, 0, 'COMMA')}"
                    >
                      금액
                    </td>

                    <!-- 일별 이익 -->
                    <td
                      th:class="'data-cell green-' + ${(categoryStat.index % 4) + 1} + ' profit'"
                    >
                      <div class="profit-detail">
                        <span
                          class="profit-amount"
                          th:text="${#numbers.formatInteger(item.dailySummary?.profit ?: 0, 0, 'COMMA')}"
                          >이익</span
                        >
                        <div
                          th:if="${item.dailySummary?.comparison != null}"
                          class="profit-change"
                        >
                          <span
                            th:class="${item.dailySummary.comparison.increase} ? 'profit-up' : 'profit-down'"
                            th:text="${item.dailySummary.comparison.increase ? '▲' : '▼'}"
                            >화살표</span
                          >
                          <span
                            th:class="${item.dailySummary.comparison.increase} ? 'profit-up' : 'profit-down'"
                            th:text="${#numbers.formatDecimal(item.dailySummary.comparison.changeRate, 0, 0)} + '%'"
                            >변화율</span
                          >
                        </div>
                      </div>
                    </td>

                    <!-- 월별 수량 -->
                    <td
                      th:class="'data-cell green-' + ${(categoryStat.index % 4) + 1}"
                      th:text="${item.monthlySummary?.quantity ?: 0}"
                    >
                      월수량
                    </td>

                    <!-- 월별 금액 -->
                    <td
                      th:class="'data-cell green-' + ${(categoryStat.index % 4) + 1} + ' amount'"
                      th:text="${#numbers.formatInteger(item.monthlySummary?.amount ?: 0, 0, 'COMMA')}"
                    >
                      월금액
                    </td>

                    <!-- 월별 이익 -->
                    <td
                      th:class="'data-cell green-' + ${(categoryStat.index % 4) + 1} + ' profit'"
                    >
                      <div class="profit-detail">
                        <span
                          class="profit-amount"
                          th:text="${#numbers.formatInteger(item.monthlySummary?.profit ?: 0, 0, 'COMMA')}"
                          >월이익</span
                        >
                        <div
                          th:if="${item.monthlySummary?.comparison != null}"
                          class="profit-change"
                        >
                          <span
                            th:class="${item.monthlySummary.comparison.increase} ? 'profit-up' : 'profit-down'"
                            th:text="${item.monthlySummary.comparison.increase ? '▲' : '▼'}"
                            >화살표</span
                          >
                          <span
                            th:class="${item.monthlySummary.comparison.increase} ? 'profit-up' : 'profit-down'"
                            th:text="${#numbers.formatDecimal(item.monthlySummary.comparison.changeRate, 1, 1)} + '%'"
                            >변화율</span
                          >
                        </div>
                      </div>
                    </td>

                    <!-- 목표 수량 (수정 가능) -->
                    <td
                      class="data-cell green-1 tooltip"
                      th:classappend="${companyFilter != '' and !isCanon} ? ' editable-cell' : ''"
                      th:data-tooltip="'목표 수량'"
                    >
                      <input
                        type="number"
                        class="quantity-input"
                        th:value="${item.targetData?.targetQuantity ?: 0}"
                        th:data-product-id="${item.productId}"
                        th:data-company-id="${companyFilter}"
                        th:data-type="'target'"
                        readonly
                        min="-999999"
                      />
                    </td>

                    <!-- 달성률 -->
                    <td
                      th:class="'data-cell green-' + ${(categoryStat.index % 4) + 1}"
                    >
                      <div class="achievement-rate">
                        <span
                          class="rate-text"
                          th:text="${#numbers.formatDecimal(item.targetData?.achievementRate ?: 0, 0, 0)} + '%'"
                          >달성률</span
                        >
                        <div class="rate-bar">
                          <div
                            class="rate-fill"
                            th:style="'width: ' + ${(item.targetData?.achievementRate ?: 0) > 100 ? 100 : (item.targetData?.achievementRate ?: 0)} + '%'"
                          ></div>
                        </div>
                      </div>
                    </td>
                  </tr>
                </th:block>

                <!-- 소계 행 (카테고리 끝에 추가) -->
                <tr
                  class="subtotal-row"
                  th:with="subtotalItem=${subtotalData[categoryEntry.key]}"
                >
                  <td colspan="5" style="text-align: left; padding-left: 15px">
                    <strong th:text="${'소계'}">소계</strong>
                  </td>
                  <!-- 실제 소계 데이터 표시 -->
                  <td>
                    <strong
                      th:text="${subtotalItem?.dailySummary?.quantity ?: 0}"
                      >소계수량</strong
                    >
                  </td>
                  <td class="amount">
                    <strong
                      th:text="${#numbers.formatInteger(subtotalItem?.dailySummary?.amount ?: 0, 0, 'COMMA')}"
                      >소계금액</strong
                    >
                  </td>
                  <td class="profit">
                    <strong
                      th:text="${#numbers.formatInteger(subtotalItem?.dailySummary?.profit ?: 0, 0, 'COMMA')}"
                      >소계이익</strong
                    >
                  </td>
                  <td>
                    <strong
                      th:text="${subtotalItem?.monthlySummary?.quantity ?: 0}"
                      >소계월수량</strong
                    >
                  </td>
                  <td class="amount">
                    <strong
                      th:text="${#numbers.formatInteger(subtotalItem?.monthlySummary?.amount ?: 0, 0, 'COMMA')}"
                      >소계월금액</strong
                    >
                  </td>
                  <td class="profit">
                    <strong
                      th:text="${#numbers.formatInteger(subtotalItem?.monthlySummary?.profit ?: 0, 0, 'COMMA')}"
                      >소계월이익</strong
                    >
                  </td>
                  <td>
                    <strong
                      th:text="${subtotalItem?.targetData?.targetQuantity ?: 0}"
                      >소계목표</strong
                    >
                  </td>
                  <td>
                    <div class="achievement-rate">
                      <span class="rate-text">
                        <strong
                          th:text="${#numbers.formatDecimal(subtotalItem?.targetData?.achievementRate ?: 0, 0, 0)} + '%'"
                          >소계달성률</strong
                        >
                      </span>
                      <div class="rate-bar">
                        <div
                          class="rate-fill"
                          th:style="'width: ' + ${(subtotalItem?.targetData?.achievementRate ?: 0) > 100 ? 100 : (subtotalItem?.targetData?.achievementRate ?: 0)} + '%'"
                        ></div>
                      </div>
                    </div>
                  </td>
                </tr>
              </th:block>

              <!-- 전체 합계 행 -->
              <tr th:if="${grandTotalData != null}" class="total-row">
                <td colspan="5" style="text-align: left; padding-left: 15px">
                  <strong th:text="${grandTotalData.productName ?: '합계'}"
                    >합계</strong
                  >
                </td>
                <!-- 실제 합계 데이터 표시 -->
                <td>
                  <strong
                    th:text="${grandTotalData.dailySummary?.quantity ?: 0}"
                    >합계수량</strong
                  >
                </td>
                <td class="amount">
                  <strong
                    th:text="${#numbers.formatInteger(grandTotalData.dailySummary?.amount ?: 0, 0, 'COMMA')}"
                    >합계금액</strong
                  >
                </td>
                <td class="profit">
                  <strong
                    th:text="${#numbers.formatInteger(grandTotalData.dailySummary?.profit ?: 0, 0, 'COMMA')}"
                    >합계이익</strong
                  >
                </td>
                <td>
                  <strong
                    th:text="${grandTotalData.monthlySummary?.quantity ?: 0}"
                    >합계월수량</strong
                  >
                </td>
                <td class="amount">
                  <strong
                    th:text="${#numbers.formatInteger(grandTotalData.monthlySummary?.amount ?: 0, 0, 'COMMA')}"
                    >합계월금액</strong
                  >
                </td>
                <td class="profit">
                  <strong
                    th:text="${#numbers.formatInteger(grandTotalData.monthlySummary?.profit ?: 0, 0, 'COMMA')}"
                    >합계월이익</strong
                  >
                </td>
                <td>
                  <strong
                    th:text="${grandTotalData.targetData?.targetQuantity ?: 0}"
                    >합계목표</strong
                  >
                </td>
                <td>
                  <div class="achievement-rate">
                    <span class="rate-text">
                      <strong
                        th:text="${#numbers.formatDecimal(grandTotalData.targetData?.achievementRate ?: 0, 0, 0)} + '%'"
                        >합계달성률</strong
                      >
                    </span>
                    <div class="rate-bar">
                      <div
                        class="rate-fill"
                        th:style="'width: ' + ${(grandTotalData.targetData?.achievementRate ?: 0) > 100 ? 100 : (grandTotalData.targetData?.achievementRate ?: 0)} + '%'"
                      ></div>
                    </div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <script th:src="@{/js/common.js}"></script>

    <!-- JavaScript -->
    <script>
      let currentDate = new Date();
      let currentCompanyFilter = "";
      let isEditMode = false;

      const currentValues = {};
      const originalValues = {};

      // 페이지 로드
      document.addEventListener("DOMContentLoaded", () => {
        const dateEl = document.getElementById("current-date");
        const companySelect = document.getElementById("company-select");

        if (dateEl) currentDate = new Date(dateEl.textContent);
        if (companySelect) currentCompanyFilter = companySelect.value || "";

        initDatePicker();
        initializeInputTracking();
        updateButtonStates();

        // 노란색 셀 직접 편집 활성화
        if (currentCompanyFilter && currentCompanyFilter !== "") {
          enableDirectCellEdit();
        }
      });

      function initDatePicker() {
        if (typeof globalDatePicker !== "undefined") {
          globalDatePicker.selectedDate = new Date(currentDate);
          globalDatePicker.init(document.getElementById("current-date"), {
            onSelect: (dateString) => {
              location.href = `/mynet/view?companyFilter=${currentCompanyFilter}&date=${dateString}`;
            },
          });
        }
      }

      function initializeInputTracking() {
        const inputs = document.querySelectorAll(".quantity-input");

        inputs.forEach((input) => {
          const productId = input.dataset.productId;
          const type = input.dataset.type;
          const key = `${productId}-${type}`;

          // 음수 허용
          const value = parseInt(input.value, 10);
          const initialValue = isNaN(value) ? 0 : value;

          currentValues[key] = initialValue;
          originalValues[key] = initialValue;

          input.addEventListener("input", () => {
            const newValue = parseInt(input.value, 10);
            currentValues[key] = isNaN(newValue) ? 0 : newValue; // 음수 허용
          });

          input.addEventListener("blur", () => {
            const savedValue = currentValues[key];
            if (input.value !== savedValue.toString()) {
              input.value = savedValue;
            }
          });
        });

        console.log("초기 currentValues:", currentValues);
      }

      // 노란색 셀 직접 클릭 편집
      function enableDirectCellEdit() {
        const editableCells = document.querySelectorAll(".editable-cell");

        editableCells.forEach((cell) => {
          const input = cell.querySelector(".quantity-input");
          if (!input) return;

          // 이미 이벤트 리스너 있으면 스킵
          if (cell.dataset.clickEnabled === "true") return;
          cell.dataset.clickEnabled = "true";

          cell.addEventListener("click", function () {
            // 이미 수정 모드면 그냥 포커스만
            if (isEditMode) {
              input.focus();
              input.select();
              return;
            }

            // 수정 모드 진입
            toggleEdit();

            // 클릭한 input에 포커스
            setTimeout(() => {
              input.focus();
              input.select();
            }, 50);
          });
        });
      }

      // 수정 모드 토글
      function toggleEdit() {
        isEditMode = !isEditMode;
        const editBtn = document.getElementById("edit-btn");
        const inputs = document.querySelectorAll(".quantity-input");

        if (isEditMode) {
          editBtn.textContent = "저장";
          editBtn.classList.add("active");

          inputs.forEach((input) => {
            input.readOnly = false;
            input.classList.add("editable");
          });
        } else {
          editBtn.textContent = "수정";
          editBtn.classList.remove("active");

          inputs.forEach((input) => {
            input.readOnly = true;
            input.classList.remove("editable");
          });

          saveAll();
        }
      }

      // 저장
      function saveAll() {
        console.log("===== 저장 시작 =====");
        console.log("currentCompanyFilter:", currentCompanyFilter);
        console.log("currentDate:", currentDate);
        console.log("currentValues:", currentValues);

        // 필수 체크
        if (
          !currentCompanyFilter ||
          currentCompanyFilter === "" ||
          currentCompanyFilter === "all"
        ) {
          showAlert("회사를 선택해주세요", "error");
          return;
        }

        // quantity와 target 데이터를 Map 형태로 변환
        const quantities = {};
        const targetQuantities = {};

        Object.entries(currentValues).forEach(([key, value]) => {
          const [productId, type] = key.split("-");
          const id = parseInt(productId, 10);
          const originalValue = originalValues[key];

          // 변경된 값만 서버로 보냄
          if (value !== originalValue) {
            if (type === "quantity") {
              quantities[id] = value;
            } else if (type === "target") {
              targetQuantities[id] = value;
            }
          }
        });

        console.log("quantities:", quantities);
        console.log("targetQuantities:", targetQuantities);

        const promises = [];

        // 수량 저장 - JSON 구조
        if (Object.keys(quantities).length > 0) {
          const requestData = {
            companyId: currentCompanyFilter,
            salesDate: formatDate(currentDate),
            quantities: quantities,
          };

          console.log("=== 수량 저장 요청 데이터 ===", requestData);

          promises.push(
            fetch("/mynet/update-quantity", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                [document.querySelector('meta[name="_csrf_header"]').content]:
                  document.querySelector('meta[name="_csrf"]').content,
              },
              body: JSON.stringify(requestData),
            })
              .then((response) => {
                console.log("수량 저장 응답:", response.status, response.ok);

                if (!response.ok) {
                  return response.text().then((text) => {
                    console.error("수량 저장 실패 응답:", text);
                    throw new Error(
                      `수량 저장 실패 (${response.status}): ${text}`,
                    );
                  });
                }

                return response.json();
              })
              .then((data) => {
                console.log("수량 저장 성공:", data);
              }),
          );
        }

        // 목표 저장 - JSON 구조
        if (Object.keys(targetQuantities).length > 0) {
          const requestData = {
            companyId: currentCompanyFilter,
            targetDate: formatDate(currentDate),
            targetQuantities: targetQuantities,
          };

          console.log("=== 목표 저장 요청 데이터 ===", requestData);

          promises.push(
            fetch("/mynet/update-target", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                [document.querySelector('meta[name="_csrf_header"]').content]:
                  document.querySelector('meta[name="_csrf"]').content,
              },
              body: JSON.stringify(requestData),
            })
              .then((response) => {
                console.log("목표 저장 응답:", response.status, response.ok);

                if (!response.ok) {
                  return response.text().then((text) => {
                    console.error("목표 저장 실패 응답:", text);
                    throw new Error(
                      `목표 저장 실패 (${response.status}): ${text}`,
                    );
                  });
                }

                return response.json();
              })
              .then((data) => {
                console.log("목표 저장 성공:", data);
              }),
          );
        }

        if (
          Object.keys(quantities).length === 0 &&
          Object.keys(targetQuantities).length === 0
        ) {
          showAlert("변경된 값이 없습니다.", "info");
          return;
        }

        Promise.all(promises)
          .then(() => {
            console.log("=== 모든 저장 성공 ===");

            // originalValues 갱신
            Object.keys(quantities).forEach((id) => {
              originalValues[`${id}-quantity`] = quantities[id];
            });

            Object.keys(targetQuantities).forEach((id) => {
              originalValues[`${id}-target`] = targetQuantities[id];
            });

            showAlert("저장되었습니다.", "success");
            setTimeout(() => location.reload(), 1000);
          })
          .catch((err) => {
            console.error("=== 저장 에러 ===", err);
            showAlert("저장 실패: " + err.message, "error");
          });
      }

      // 유틸
      function formatDate(date) {
        return date.toISOString().split("T")[0];
      }

      function updateButtonStates() {
        const editBtn = document.getElementById("edit-btn");
        if (!editBtn) return;

        if (!currentCompanyFilter) {
          editBtn.style.display = "none";
        } else {
          editBtn.style.display = "inline-block";
        }
      }

      function changeDate(days) {
        const d = new Date(currentDate);
        d.setDate(d.getDate() + days);
        location.href = `/mynet/view?companyFilter=${currentCompanyFilter}&date=${formatDate(
          d,
        )}`;
      }

      function changeCompany(companyId) {
        location.href = `/mynet/view?companyFilter=${companyId}&date=${formatDate(
          currentDate,
        )}`;
      }

      function showAlert(message, type) {
        const container = document.getElementById("alert-container");
        const div = document.createElement("div");
        div.className = `alert alert-${type}`;
        div.textContent = message;
        container.appendChild(div);
        setTimeout(() => div.remove(), 3000);
      }

      function selectTotalStats() {
        const dateStr = formatDate(currentDate);
        location.href = `/mynet/view?companyFilter=&date=${dateStr}`;
      }

      function showDatePicker() {
        if (typeof globalDatePicker !== "undefined") {
          globalDatePicker.currentDate = new Date(currentDate);
          globalDatePicker.selectedDate = new Date(currentDate);
          globalDatePicker.show();
        }
      }

      function selectDate() {
        const datePicker = document.getElementById("date-picker");
        location.href = `/mynet/view?companyFilter=${currentCompanyFilter}&date=${datePicker.value}`;
      }

      function updateDateDisplay() {
        const dateEl = document.getElementById("current-date");
        const pickerEl = document.getElementById("date-picker");
        const dateStr = formatDate(currentDate);
        if (dateEl) dateEl.textContent = dateStr;
        if (pickerEl) pickerEl.value = dateStr;
      }

      // 엑셀 다운로드
      function downloadExcel() {
        const dateStr = formatDate(currentDate);
        const downloadUrl = `/mynet/view/download?companyFilter=${currentCompanyFilter}&date=${dateStr}`;

        window.location.href = downloadUrl;
      }
    </script>
  </body>
</html>
